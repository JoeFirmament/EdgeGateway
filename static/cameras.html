<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RK3588摄像头服务器 - 设备管理</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>RK3588摄像头服务器</h1>
        </header>

        <nav>
            <ul>
                <li><a href="index.html">实时预览</a></li>
                <li><a href="cameras.html" class="active">设备管理</a></li>
                <li><a href="camera_select.html">摄像头选择</a></li>
                <li><a href="system_info.html">系统信息</a></li>
            </ul>
        </nav>

        <main>
            <div class="card">
                <h2>摄像头设备管理</h2>

                <div id="message" class="message hidden"></div>

                <div id="loading" class="loading">正在加载摄像头设备列表...</div>

                <div id="camera-list" class="camera-list"></div>

                <div id="preview-container" class="preview-container hidden">
                    <h3>摄像头预览</h3>
                    <img id="preview" src="" alt="摄像头预览">
                    <div class="controls mt-2">
                        <button id="refresh-preview" class="btn">刷新预览</button>
                        <button id="stop-preview" class="btn btn-danger">停止预览</button>
                    </div>
                </div>
            </div>
        </main>

        <footer>
            <p>&copy; 2023 RK3588摄像头服务器 | 版本: 0.1.0</p>
        </footer>
    </div>

    <script>
        // 页面加载完成后执行
        document.addEventListener('DOMContentLoaded', function() {
            // 获取摄像头列表
            fetchCameras();
        });

        // 获取摄像头列表
        function fetchCameras() {
            fetch('/api/cameras')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('获取摄像头列表失败');
                    }
                    return response.json();
                })
                .then(data => {
                    displayCameras(data.cameras);
                })
                .catch(error => {
                    showMessage(error.message, 'error');
                    console.error('Error:', error);
                })
                .finally(() => {
                    document.getElementById('loading').classList.add('hidden');
                });
        }

        // 显示摄像头列表
        function displayCameras(cameras) {
            const cameraList = document.getElementById('camera-list');
            cameraList.innerHTML = '';

            if (cameras.length === 0) {
                showMessage('未找到可用的摄像头设备', 'error');
                return;
            }

            cameras.forEach(camera => {
                const card = document.createElement('div');
                card.className = 'camera-card';

                // 设备名称和路径
                const title = document.createElement('h3');
                title.textContent = camera.name || '未知设备';
                card.appendChild(title);

                const path = document.createElement('p');
                path.textContent = `设备路径: ${camera.path}`;
                card.appendChild(path);

                const busInfo = document.createElement('p');
                busInfo.textContent = `总线信息: ${camera.bus_info || '未知'}`;
                card.appendChild(busInfo);

                // 格式选择
                const formatLabel = document.createElement('p');
                formatLabel.textContent = '选择格式:';
                card.appendChild(formatLabel);

                const formatSelect = document.createElement('select');
                formatSelect.id = `format-${camera.path}`;

                const formats = Object.keys(camera.formats);
                formats.forEach(format => {
                    const option = document.createElement('option');
                    option.value = format;
                    option.textContent = format;
                    formatSelect.appendChild(option);
                });

                card.appendChild(formatSelect);

                // 分辨率选择
                const resolutionLabel = document.createElement('p');
                resolutionLabel.textContent = '选择分辨率:';
                card.appendChild(resolutionLabel);

                const resolutionSelect = document.createElement('select');
                resolutionSelect.id = `resolution-${camera.path}`;

                // 初始化分辨率选项
                updateResolutionOptions(camera, formatSelect.value, resolutionSelect);

                // 当格式改变时更新分辨率选项
                formatSelect.addEventListener('change', function() {
                    updateResolutionOptions(camera, this.value, resolutionSelect);
                });

                card.appendChild(resolutionSelect);

                // 帧率选择
                const fpsLabel = document.createElement('p');
                fpsLabel.textContent = '选择帧率:';
                card.appendChild(fpsLabel);

                const fpsSelect = document.createElement('select');
                fpsSelect.id = `fps-${camera.path}`;

                [10, 15, 20, 25, 30].forEach(fps => {
                    const option = document.createElement('option');
                    option.value = fps;
                    option.textContent = `${fps} FPS`;
                    if (fps === 30) {
                        option.selected = true;
                    }
                    fpsSelect.appendChild(option);
                });

                card.appendChild(fpsSelect);

                // 打开按钮
                const openButton = document.createElement('button');
                openButton.textContent = '打开摄像头';
                openButton.addEventListener('click', function() {
                    openCamera(
                        camera.path,
                        formatSelect.value,
                        resolutionSelect.value,
                        fpsSelect.value
                    );
                });
                card.appendChild(openButton);

                cameraList.appendChild(card);
            });
        }

        // 更新分辨率选项
        function updateResolutionOptions(camera, format, resolutionSelect) {
            resolutionSelect.innerHTML = '';

            if (camera.formats[format]) {
                const resolutions = camera.formats[format];

                // 按分辨率大小排序
                const sortedResolutions = resolutions.sort((a, b) => {
                    return (a.width * a.height) - (b.width * b.height);
                });

                sortedResolutions.forEach(res => {
                    const option = document.createElement('option');
                    option.value = `${res.width}x${res.height}`;
                    option.textContent = `${res.width}x${res.height}`;
                    resolutionSelect.appendChild(option);
                });
            }
        }

        // 打开摄像头
        function openCamera(devicePath, format, resolution, fps) {
            // 解析分辨率
            const [width, height] = resolution.split('x').map(Number);

            // 构建请求数据
            const data = {
                device_path: devicePath,
                format: format,
                width: width,
                height: height,
                fps: parseInt(fps)
            };

            // 发送请求
            fetch('/api/cameras/open', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('打开摄像头失败');
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    showMessage('摄像头已成功打开', 'success');

                    // 显示预览
                    const previewContainer = document.getElementById('preview-container');
                    previewContainer.classList.remove('hidden');

                    // 设置预览图像源，添加时间戳防止缓存
                    const preview = document.getElementById('preview');
                    preview.src = `/api/stream?width=${width}&height=${height}&quality=80&fps=${fps}&t=${Date.now()}`;
                } else {
                    showMessage(data.error || '打开摄像头失败', 'error');
                }
            })
            .catch(error => {
                showMessage(error.message, 'error');
                console.error('Error:', error);
            });
        }

        // 显示消息
        function showMessage(message, type) {
            const messageElement = document.getElementById('message');
            messageElement.textContent = message;
            messageElement.className = type;
            messageElement.classList.remove('hidden');

            // 5秒后隐藏消息
            setTimeout(() => {
                messageElement.classList.add('hidden');
            }, 5000);
        }
    </script>
</body>
</html>
