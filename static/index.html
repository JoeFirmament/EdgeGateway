<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RK3588摄像头服务器 - 实时预览</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>RK3588摄像头服务器</h1>
        </header>

        <nav>
            <ul>
                <li><a href="index.html" class="active">实时预览</a></li>
                <li><a href="cameras.html">设备管理</a></li>
                <li><a href="camera_select.html">摄像头选择</a></li>
                <li><a href="system_info.html">系统信息</a></li>
            </ul>
        </nav>

        <main>
            <div class="card">
                <h2>摄像头实时预览</h2>

                <div class="stream-container">
                    <img id="stream" alt="摄像头实时预览" src="/api/stream">
                    <div id="loading" class="loading hidden">正在加载视频流...</div>
                    <div id="error-message" class="message error hidden">无法连接到摄像头流</div>
                </div>

                <div class="card">
                    <h3>流设置</h3>
                    <div class="row">
                        <div class="col">
                            <div class="form-group">
                                <label for="resolution">分辨率:</label>
                                <select id="resolution" class="form-control">
                                    <option value="640x480">640x480</option>
                                    <option value="800x600">800x600</option>
                                    <option value="1280x720" selected>1280x720 (HD)</option>
                                    <option value="1920x1080">1920x1080 (Full HD)</option>
                                </select>
                            </div>
                        </div>

                        <div class="col">
                            <div class="form-group">
                                <label for="quality">质量 (1-100):</label>
                                <input type="number" id="quality" class="form-control" min="1" max="100" value="80">
                            </div>
                        </div>

                        <div class="col">
                            <div class="form-group">
                                <label for="fps">帧率:</label>
                                <select id="fps" class="form-control">
                                    <option value="5">5 FPS</option>
                                    <option value="10">10 FPS</option>
                                    <option value="15">15 FPS</option>
                                    <option value="20">20 FPS</option>
                                    <option value="25">25 FPS</option>
                                    <option value="30" selected>30 FPS</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="controls">
                        <button id="apply" class="btn">应用设置</button>
                        <button id="refresh" class="btn">刷新流</button>
                        <button id="capture" class="btn btn-secondary">拍照</button>
                        <button id="record" class="btn btn-secondary">开始录制</button>
                    </div>
                </div>

                <div id="status" class="message success">
                    已连接到摄像头流
                </div>

                <div class="card">
                    <h3>摄像头信息</h3>
                    <div id="camera-info" class="info-table">
                        <table>
                            <tr>
                                <td>设备:</td>
                                <td id="device-path">/dev/video0</td>
                            </tr>
                            <tr>
                                <td>分辨率:</td>
                                <td id="current-resolution">1280x720</td>
                            </tr>
                            <tr>
                                <td>帧率:</td>
                                <td id="current-fps">30 FPS</td>
                            </tr>
                            <tr>
                                <td>状态:</td>
                                <td id="camera-status"><span class="status-ok">正常</span></td>
                            </tr>
                        </table>
                    </div>
                </div>

                <div class="info">
                    <p>提示: 如果流无法显示，请检查摄像头是否已连接并正常工作。</p>
                    <p>您可以调整分辨率、质量和帧率来优化性能和图像质量。</p>
                </div>
            </div>
        </main>

        <footer>
            <p>&copy; 2023 RK3588摄像头服务器 | 版本: 0.1.0</p>
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // DOM元素
            const streamImg = document.getElementById('stream');
            const loadingDiv = document.getElementById('loading');
            const errorMessageDiv = document.getElementById('error-message');
            const resolutionSelect = document.getElementById('resolution');
            const qualityInput = document.getElementById('quality');
            const fpsSelect = document.getElementById('fps');
            const applyButton = document.getElementById('apply');
            const refreshButton = document.getElementById('refresh');
            const captureButton = document.getElementById('capture');
            const recordButton = document.getElementById('record');
            const statusDiv = document.getElementById('status');
            const devicePathElement = document.getElementById('device-path');
            const currentResolutionElement = document.getElementById('current-resolution');
            const currentFpsElement = document.getElementById('current-fps');
            const cameraStatusElement = document.getElementById('camera-status');

            // 状态变量
            let isRecording = false;
            let recordingStartTime = null;

            // 初始化
            loadCameraInfo();

            // 应用设置
            function applySettings() {
                showLoading();

                const [width, height] = resolutionSelect.value.split('x');
                const quality = qualityInput.value;
                const fps = fpsSelect.value;

                const streamUrl = `/api/stream?width=${width}&height=${height}&quality=${quality}&fps=${fps}&t=${Date.now()}`;
                streamImg.src = streamUrl;

                // 更新摄像头信息
                currentResolutionElement.textContent = `${width}x${height}`;
                currentFpsElement.textContent = `${fps} FPS`;

                // 显示消息
                showMessage(`已应用新设置: 分辨率=${width}x${height}, 质量=${quality}, 帧率=${fps}`, 'success');

                console.log(`应用新设置: 分辨率=${width}x${height}, 质量=${quality}, 帧率=${fps}`);
            }

            // 刷新流
            function refreshStream() {
                showLoading();

                const [width, height] = resolutionSelect.value.split('x');
                const quality = qualityInput.value;
                const fps = fpsSelect.value;

                // 添加时间戳避免缓存
                const streamUrl = `/api/stream?width=${width}&height=${height}&quality=${quality}&fps=${fps}&t=${Date.now()}`;
                streamImg.src = streamUrl;

                showMessage('视频流已刷新', 'info');
            }

            // 拍照
            function captureImage() {
                if (!streamImg.complete || streamImg.naturalWidth === 0) {
                    showMessage('无法拍照：摄像头未连接', 'error');
                    return;
                }

                // 创建canvas元素
                const canvas = document.createElement('canvas');
                canvas.width = streamImg.naturalWidth;
                canvas.height = streamImg.naturalHeight;

                // 绘制当前帧
                const ctx = canvas.getContext('2d');
                ctx.drawImage(streamImg, 0, 0);

                try {
                    // 转换为图片并下载
                    const dataUrl = canvas.toDataURL('image/jpeg', qualityInput.value / 100);
                    const link = document.createElement('a');
                    link.href = dataUrl;
                    link.download = `capture_${new Date().toISOString().replace(/:/g, '-')}.jpg`;
                    link.click();

                    showMessage('图片已保存', 'success');
                } catch (error) {
                    console.error('拍照失败:', error);
                    showMessage('拍照失败: ' + error.message, 'error');
                }
            }

            // 录制视频
            function toggleRecording() {
                if (isRecording) {
                    // 停止录制
                    stopRecording();
                } else {
                    // 开始录制
                    startRecording();
                }
            }

            // 开始录制
            function startRecording() {
                fetch('/api/cameras/start_recording', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        format: 'mp4',
                        duration: 0 // 0表示无限制，直到手动停止
                    })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('开始录制请求失败');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        isRecording = true;
                        recordingStartTime = Date.now();
                        recordButton.textContent = '停止录制';
                        recordButton.classList.add('btn-danger');

                        // 开始更新录制时间
                        updateRecordingTime();

                        showMessage('录制已开始', 'success');
                    } else {
                        showMessage(data.error || '开始录制失败', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showMessage('开始录制失败: ' + error.message, 'error');
                });
            }

            // 停止录制
            function stopRecording() {
                fetch('/api/cameras/stop_recording', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('停止录制请求失败');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        isRecording = false;
                        recordButton.textContent = '开始录制';
                        recordButton.classList.remove('btn-danger');

                        showMessage(`录制已停止，视频已保存: ${data.file_path || '未知路径'}`, 'success');
                    } else {
                        showMessage(data.error || '停止录制失败', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showMessage('停止录制失败: ' + error.message, 'error');
                });
            }

            // 更新录制时间
            function updateRecordingTime() {
                if (!isRecording) return;

                const elapsedTime = Math.floor((Date.now() - recordingStartTime) / 1000);
                const hours = Math.floor(elapsedTime / 3600);
                const minutes = Math.floor((elapsedTime % 3600) / 60);
                const seconds = elapsedTime % 60;

                const timeStr = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                recordButton.textContent = `停止录制 (${timeStr})`;

                setTimeout(updateRecordingTime, 1000);
            }

            // 加载摄像头信息
            function loadCameraInfo() {
                fetch('/camCapture')
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('获取摄像头信息失败');
                        }
                        return response.json();
                    })
                    .then(data => {
                        // 更新摄像头信息
                        devicePathElement.textContent = data.device;
                        currentResolutionElement.textContent = data.resolution;
                        currentFpsElement.textContent = `${data.fps} FPS`;

                        // 更新摄像头状态
                        if (data.is_capturing) {
                            cameraStatusElement.innerHTML = '<span class="status-ok">正在捕获</span>';
                        } else {
                            cameraStatusElement.innerHTML = '<span class="status-warning">未捕获</span>';
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        cameraStatusElement.innerHTML = '<span class="status-error">错误</span>';
                    });
            }

            // 检查流状态
            function checkStreamStatus() {
                if (streamImg.complete && streamImg.naturalWidth > 0) {
                    // 流已连接
                    streamImg.style.display = 'block';
                    loadingDiv.classList.add('hidden');
                    errorMessageDiv.classList.add('hidden');
                    statusDiv.className = 'message success';
                    statusDiv.textContent = '已连接到摄像头流';
                    cameraStatusElement.innerHTML = '<span class="status-ok">正常</span>';
                } else {
                    // 流未连接
                    streamImg.style.display = 'none';
                    loadingDiv.classList.add('hidden');
                    errorMessageDiv.classList.remove('hidden');
                    statusDiv.className = 'message error';
                    statusDiv.textContent = '无法连接到摄像头流';
                    cameraStatusElement.innerHTML = '<span class="status-error">错误</span>';
                }
            }

            // 显示加载中
            function showLoading() {
                streamImg.style.display = 'none';
                loadingDiv.classList.remove('hidden');
                errorMessageDiv.classList.add('hidden');
            }

            // 显示消息
            function showMessage(message, type) {
                statusDiv.textContent = message;
                statusDiv.className = `message ${type}`;

                // 5秒后恢复原状态
                setTimeout(() => {
                    checkStreamStatus();
                }, 5000);
            }

            // 事件监听器
            applyButton.addEventListener('click', applySettings);
            refreshButton.addEventListener('click', refreshStream);
            captureButton.addEventListener('click', captureImage);
            recordButton.addEventListener('click', toggleRecording);

            // 图像加载事件
            streamImg.addEventListener('load', () => {
                loadingDiv.classList.add('hidden');
                streamImg.style.display = 'block';
                checkStreamStatus();
            });

            streamImg.addEventListener('error', () => {
                loadingDiv.classList.add('hidden');
                errorMessageDiv.classList.remove('hidden');
                streamImg.style.display = 'none';
                checkStreamStatus();
            });

            // 初始检查
            setTimeout(checkStreamStatus, 1000);

            // 定期刷新摄像头信息
            setInterval(loadCameraInfo, 5000);
        });
    </script>
</body>
</html>
