<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ–¼ï¸ MJPEGå¸§æå–å·¥å…· - æ·±è§†è¾¹ç¼˜è§†è§‰å¹³å°</title>
    <link rel="stylesheet" href="/static/css/unified-style.css">
</head>
<body>
    <div class="app-container">
        <!-- é¡¶éƒ¨å¯¼èˆª -->
        <div id="navigation-container"></div>

        <!-- é¡µé¢æ ‡é¢˜ -->
        <header class="page-header">
            <h1 class="page-title">Frame Extraction</h1>
            <p class="page-subtitle">DeepVision Edge Platform - Extract frames from MJPEG videos for AI training</p>
        </header>

        <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
        <div class="grid grid-2">
            <!-- å·¦ä¾§ï¼šæ–‡ä»¶é€‰æ‹©å’Œæå–æ§åˆ¶ -->
            <div class="card fade-in">
                <div class="card-header">
                    <h3 class="card-title">ğŸ“ æ–‡ä»¶é€‰æ‹©</h3>
                </div>

                <!-- å½•åˆ¶æ–‡ä»¶åˆ—è¡¨ -->
                <div class="form-group">
                    <label class="form-label">é€‰æ‹©MJPEGæ–‡ä»¶:</label>
                    <select class="form-select" id="videoFileSelect">
                        <option value="">æ­£åœ¨åŠ è½½å½•åˆ¶æ–‡ä»¶...</option>
                    </select>
                </div>

                <!-- æ–‡ä»¶ä¿¡æ¯æ˜¾ç¤º -->
                <div class="status-panel" id="fileInfo" style="display: none;">
                    <div class="status-item">
                        <span class="status-label">æ–‡ä»¶å:</span>
                        <span class="status-value" id="fileName">-</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">æ–‡ä»¶å¤§å°:</span>
                        <span class="status-value" id="fileSize">-</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">åˆ›å»ºæ—¶é—´:</span>
                        <span class="status-value" id="fileTime">-</span>
                    </div>
                </div>

                <!-- æå–è®¾ç½® -->
                <div class="form-group">
                    <label class="form-label">æå–é—´éš”:</label>
                    <select class="form-select" id="extractInterval">
                        <option value="1">æ¯å¸§æå– (å…¨éƒ¨å¸§)</option>
                        <option value="5" selected>æ¯5å¸§æå–ä¸€æ¬¡</option>
                        <option value="10">æ¯10å¸§æå–ä¸€æ¬¡</option>
                        <option value="30">æ¯30å¸§æå–ä¸€æ¬¡ (çº¦1ç§’)</option>
                        <option value="60">æ¯60å¸§æå–ä¸€æ¬¡ (çº¦2ç§’)</option>
                    </select>
                </div>

                <!-- è¾“å‡ºæ ¼å¼ -->
                <div class="form-group">
                    <label class="form-label">è¾“å‡ºæ ¼å¼:</label>
                    <select class="form-select" id="outputFormat">
                        <option value="jpg" selected>JPEG (.jpg)</option>
                        <option value="png">PNG (.png)</option>
                    </select>
                </div>

                <!-- æ§åˆ¶æŒ‰é’® -->
                <div class="control-row">
                    <button class="btn btn-primary" id="startExtractionBtn" disabled>
                        ğŸš€ å¼€å§‹æå–
                    </button>
                    <button class="btn btn-danger" id="stopExtractionBtn" disabled>
                        ğŸ›‘ åœæ­¢æå–
                    </button>
                </div>
            </div>

            <!-- å³ä¾§ï¼šæå–çŠ¶æ€å’Œè¿›åº¦ -->
            <div class="card fade-in">
                <div class="card-header">
                    <h3 class="card-title">ğŸ“Š æå–çŠ¶æ€</h3>
                </div>

                <!-- è¿›åº¦æ˜¾ç¤º -->
                <div class="status-panel">
                    <div class="status-item">
                        <span class="status-label">æå–çŠ¶æ€:</span>
                        <span class="status-value" id="extractionStatus">å¾…æœº</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">å·²æå–å¸§æ•°:</span>
                        <span class="status-value" id="extractedFrames">0</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">æ€»å¸§æ•°:</span>
                        <span class="status-value" id="totalFrames">-</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">è¿›åº¦:</span>
                        <span class="status-value" id="progress">0%</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">è¾“å‡ºç›®å½•:</span>
                        <span class="status-value" id="outputDir">-</span>
                    </div>
                </div>

                <!-- è¿›åº¦æ¡ -->
                <div style="margin: 16px 0;">
                    <div style="background: rgba(233, 236, 239, 0.6); height: 8px; border-radius: 2px; overflow: hidden;">
                        <div id="progressBar" style="background: rgba(120, 150, 130, 0.6); height: 100%; width: 0%; transition: width 0.3s ease;"></div>
                    </div>
                </div>

                <!-- æœ€æ–°æå–çš„å¸§é¢„è§ˆ -->
                <div class="form-group">
                    <label class="form-label">æå–å¸§é¢„è§ˆ:</label>
                    <div class="video-container" style="height: 200px;">
                        <div id="framePreview" style="width: 100%; height: 100%; display: none; align-items: center; justify-content: center;"></div>
                        <div id="noPreview" style="display: flex; align-items: center; justify-content: center; height: 100%; color: rgba(127, 140, 141, 0.7);">
                            æš‚æ— é¢„è§ˆ
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- æå–ç»“æœ -->
        <div class="card fade-in" id="resultsCard" style="display: none;">
            <div class="card-header">
                <h3 class="card-title">ğŸ“¦ æå–ç»“æœ</h3>
                <div class="card-actions">
                    <button class="btn btn-success btn-small" id="downloadResultsBtn" disabled>
                        ğŸ’¾ ä¸‹è½½å‹ç¼©åŒ…
                    </button>
                </div>
            </div>

            <div class="status-panel">
                <div class="status-item">
                    <span class="status-label">æå–å®Œæˆæ—¶é—´:</span>
                    <span class="status-value" id="completionTime">-</span>
                </div>
                <div class="status-item">
                    <span class="status-label">æˆåŠŸæå–å¸§æ•°:</span>
                    <span class="status-value success" id="successFrames">0</span>
                </div>
                <div class="status-item">
                    <span class="status-label">å‹ç¼©åŒ…å¤§å°:</span>
                    <span class="status-value" id="archiveSize">-</span>
                </div>
                <div class="status-item">
                    <span class="status-label">ä¸‹è½½é“¾æ¥:</span>
                    <span class="status-value" id="downloadLink">-</span>
                </div>
            </div>
        </div>

        <!-- æ—¥å¿—åŒºåŸŸ -->
        <div class="log-container">
            <div class="log-header">
                <h3 style="color: rgba(255, 255, 255, 0.9); margin: 0;">ğŸ“‹ æå–æ—¥å¿—</h3>
                <button class="btn btn-warning btn-small" onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
            </div>
            <div class="log-content" id="logContent"></div>
        </div>
    </div>

    <script src="/static/js/navigation.js"></script>
    <script>
        // å…¨å±€å˜é‡
        let extractionInProgress = false;
        let extractionTaskId = null;

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            log('ğŸ¬ MJPEGå¸§æå–å·¥å…·å·²åŠ è½½');
            loadVideoFiles();
            bindEvents();
        });

        // ç»‘å®šäº‹ä»¶
        function bindEvents() {
            // æ–‡ä»¶é€‰æ‹©äº‹ä»¶
            document.getElementById('videoFileSelect').addEventListener('change', onFileSelect);

            // æŒ‰é’®äº‹ä»¶
            document.getElementById('startExtractionBtn').addEventListener('click', startExtraction);
            document.getElementById('stopExtractionBtn').addEventListener('click', stopExtraction);
            document.getElementById('downloadResultsBtn').addEventListener('click', downloadResults);
        }

        // åŠ è½½å½•åˆ¶æ–‡ä»¶åˆ—è¡¨
        function loadVideoFiles() {
            log('ğŸ“ æ­£åœ¨åŠ è½½å½•åˆ¶æ–‡ä»¶åˆ—è¡¨...');

            fetch('/api/videos')
                .then(response => response.json())
                .then(data => {
                    const select = document.getElementById('videoFileSelect');
                    select.innerHTML = '<option value="">è¯·é€‰æ‹©MJPEGæ–‡ä»¶</option>';

                    if (data.videos && data.videos.length > 0) {
                        // åªæ˜¾ç¤ºMJPEGæ–‡ä»¶
                        const mjpegFiles = data.videos.filter(video =>
                            video.filename.toLowerCase().endsWith('.mjpeg')
                        );

                        if (mjpegFiles.length > 0) {
                            mjpegFiles.forEach(video => {
                                const option = document.createElement('option');
                                option.value = video.filename;
                                option.textContent = `${video.filename} (${(video.size / 1024 / 1024).toFixed(1)} MB)`;
                                option.dataset.video = JSON.stringify(video);
                                select.appendChild(option);
                            });
                            log(`âœ… åŠ è½½äº† ${mjpegFiles.length} ä¸ªMJPEGæ–‡ä»¶`);
                        } else {
                            log('âš ï¸ æ²¡æœ‰æ‰¾åˆ°MJPEGæ–‡ä»¶');
                            select.innerHTML = '<option value="">æ²¡æœ‰æ‰¾åˆ°MJPEGæ–‡ä»¶</option>';
                        }
                    } else {
                        log('âš ï¸ æ²¡æœ‰æ‰¾åˆ°å½•åˆ¶æ–‡ä»¶');
                        select.innerHTML = '<option value="">æ²¡æœ‰æ‰¾åˆ°å½•åˆ¶æ–‡ä»¶</option>';
                    }
                })
                .catch(error => {
                    log(`âŒ åŠ è½½æ–‡ä»¶åˆ—è¡¨å¤±è´¥: ${error.message}`, 'error');
                    const select = document.getElementById('videoFileSelect');
                    select.innerHTML = '<option value="">åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•</option>';
                });
        }

        // æ–‡ä»¶é€‰æ‹©å¤„ç†
        function onFileSelect(event) {
            const select = event.target;
            const selectedOption = select.options[select.selectedIndex];

            if (selectedOption.value && selectedOption.dataset.video) {
                const video = JSON.parse(selectedOption.dataset.video);
                showFileInfo(video);
                document.getElementById('startExtractionBtn').disabled = false;
                log(`ğŸ“„ é€‰æ‹©æ–‡ä»¶: ${video.filename}`);
            } else {
                hideFileInfo();
                document.getElementById('startExtractionBtn').disabled = true;
            }
        }

        // æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
        function showFileInfo(video) {
            document.getElementById('fileName').textContent = video.filename;
            document.getElementById('fileSize').textContent = `${(video.size / 1024 / 1024).toFixed(2)} MB`;
            document.getElementById('fileTime').textContent = new Date(video.timestamp * 1000).toLocaleString();
            document.getElementById('fileInfo').style.display = 'block';
        }

        // éšè—æ–‡ä»¶ä¿¡æ¯
        function hideFileInfo() {
            document.getElementById('fileInfo').style.display = 'none';
        }

        // æ—¥å¿—å‡½æ•°
        function log(message, type = 'info') {
            const logContent = document.getElementById('logContent');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}\n`;
            logContent.textContent += logEntry;
            logContent.scrollTop = logContent.scrollHeight;
        }

        // æ¸…ç©ºæ—¥å¿—
        function clearLog() {
            document.getElementById('logContent').textContent = '';
        }

        // å¼€å§‹æå–
        function startExtraction() {
            const fileSelect = document.getElementById('videoFileSelect');
            const selectedFile = fileSelect.value;

            if (!selectedFile) {
                log('âŒ è¯·å…ˆé€‰æ‹©è¦æå–çš„æ–‡ä»¶', 'error');
                return;
            }

            const interval = document.getElementById('extractInterval').value;
            const format = document.getElementById('outputFormat').value;

            log(`ğŸš€ å¼€å§‹æå–å¸§: ${selectedFile}`);
            log(`âš™ï¸ æå–é—´éš”: æ¯${interval}å¸§, è¾“å‡ºæ ¼å¼: ${format.toUpperCase()}`);

            // æ›´æ–°UIçŠ¶æ€
            extractionInProgress = true;
            document.getElementById('startExtractionBtn').disabled = true;
            document.getElementById('stopExtractionBtn').disabled = false;
            document.getElementById('extractionStatus').textContent = 'æ­£åœ¨æå–...';
            document.getElementById('extractionStatus').className = 'status-value warning';

            // å‘é€æå–è¯·æ±‚
            const requestData = {
                filename: selectedFile,
                interval: parseInt(interval),
                format: format
            };

            fetch('/api/frame-extraction/start', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    extractionTaskId = data.task_id;
                    log(`âœ… æå–ä»»åŠ¡å·²å¯åŠ¨ï¼Œä»»åŠ¡ID: ${extractionTaskId}`);
                    startProgressPolling();
                } else {
                    throw new Error(data.error || 'å¯åŠ¨æå–ä»»åŠ¡å¤±è´¥');
                }
            })
            .catch(error => {
                log(`âŒ å¯åŠ¨æå–å¤±è´¥: ${error.message}`, 'error');
                resetExtractionState();
            });
        }

        // åœæ­¢æå–
        function stopExtraction() {
            if (!extractionTaskId) {
                log('âŒ æ²¡æœ‰æ­£åœ¨è¿›è¡Œçš„æå–ä»»åŠ¡', 'error');
                return;
            }

            log('ğŸ›‘ æ­£åœ¨åœæ­¢æå–ä»»åŠ¡...');

            fetch(`/api/frame-extraction/stop/${extractionTaskId}`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    log('âœ… æå–ä»»åŠ¡å·²åœæ­¢');
                } else {
                    log(`âš ï¸ åœæ­¢ä»»åŠ¡æ—¶å‡ºç°é—®é¢˜: ${data.error || 'æœªçŸ¥é”™è¯¯'}`);
                }
                resetExtractionState();
            })
            .catch(error => {
                log(`âŒ åœæ­¢æå–å¤±è´¥: ${error.message}`, 'error');
                resetExtractionState();
            });
        }

        // å¼€å§‹è¿›åº¦è½®è¯¢
        function startProgressPolling() {
            const pollInterval = setInterval(() => {
                if (!extractionInProgress || !extractionTaskId) {
                    clearInterval(pollInterval);
                    return;
                }

                fetch(`/api/frame-extraction/status/${extractionTaskId}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            updateProgress(data.status);

                            if (data.status.completed) {
                                clearInterval(pollInterval);
                                onExtractionComplete(data.status);
                            }
                        } else {
                            log(`âŒ è·å–è¿›åº¦å¤±è´¥: ${data.error}`, 'error');
                        }
                    })
                    .catch(error => {
                        log(`âŒ è½®è¯¢è¿›åº¦å¤±è´¥: ${error.message}`, 'error');
                    });
            }, 1000); // æ¯ç§’è½®è¯¢ä¸€æ¬¡
        }

        // æ›´æ–°è¿›åº¦æ˜¾ç¤º
        function updateProgress(status) {
            document.getElementById('extractedFrames').textContent = status.extracted_frames || 0;
            document.getElementById('totalFrames').textContent = status.total_frames || '-';
            document.getElementById('outputDir').textContent = status.output_dir || '-';

            const progress = status.total_frames > 0 ?
                Math.round((status.extracted_frames / status.total_frames) * 100) : 0;

            document.getElementById('progress').textContent = `${progress}%`;
            document.getElementById('progressBar').style.width = `${progress}%`;

            // æå–å®Œæˆåæ˜¾ç¤ºä¸‰å¸§é¢„è§ˆ
            if (status.completed && status.preview_frames) {
                showThreeFramePreview(status.preview_frames);
            }
        }

        // æ˜¾ç¤ºä¸‰å¸§é¢„è§ˆ
        function showThreeFramePreview(previewFrames) {
            const preview = document.getElementById('framePreview');
            const noPreview = document.getElementById('noPreview');

            log('ğŸ–¼ï¸ å¼€å§‹æ˜¾ç¤ºä¸‰å¸§é¢„è§ˆ...');
            console.log('Preview frames data:', previewFrames);

            // åˆ›å»ºä¸‰å¸§é¢„è§ˆå®¹å™¨
            preview.innerHTML = `
                <div style="display: flex; gap: 10px; justify-content: center; align-items: center; height: 100%;">
                    <div style="text-align: center;">
                        <div style="font-size: 12px; margin-bottom: 5px; color: #666;">é¦–å¸§</div>
                        <img src="${previewFrames.first}" style="max-width: 120px; max-height: 80px; border: 1px solid #ddd; border-radius: 4px;" alt="é¦–å¸§" onload="console.log('é¦–å¸§åŠ è½½æˆåŠŸ')" onerror="console.log('é¦–å¸§åŠ è½½å¤±è´¥')">
                    </div>
                    ${previewFrames.middle ? `
                    <div style="text-align: center;">
                        <div style="font-size: 12px; margin-bottom: 5px; color: #666;">ä¸­é—´å¸§</div>
                        <img src="${previewFrames.middle}" style="max-width: 120px; max-height: 80px; border: 1px solid #ddd; border-radius: 4px;" alt="ä¸­é—´å¸§" onload="console.log('ä¸­é—´å¸§åŠ è½½æˆåŠŸ')" onerror="console.log('ä¸­é—´å¸§åŠ è½½å¤±è´¥')">
                    </div>
                    ` : ''}
                    <div style="text-align: center;">
                        <div style="font-size: 12px; margin-bottom: 5px; color: #666;">æœ«å¸§</div>
                        <img src="${previewFrames.last}" style="max-width: 120px; max-height: 80px; border: 1px solid #ddd; border-radius: 4px;" alt="æœ«å¸§" onload="console.log('æœ«å¸§åŠ è½½æˆåŠŸ')" onerror="console.log('æœ«å¸§åŠ è½½å¤±è´¥')">
                    </div>
                </div>
            `;

            preview.style.display = 'flex';
            noPreview.style.display = 'none';

            log('ğŸ–¼ï¸ ä¸‰å¸§é¢„è§ˆå·²è®¾ç½®ï¼šé¦–å¸§ã€ä¸­é—´å¸§ã€æœ«å¸§');
        }

        // æå–å®Œæˆå¤„ç†
        function onExtractionComplete(status) {
            log('ğŸ‰ å¸§æå–å®Œæˆï¼');
            console.log('Complete status data:', status);

            // æ›´æ–°çŠ¶æ€
            document.getElementById('extractionStatus').textContent = 'æå–å®Œæˆ';
            document.getElementById('extractionStatus').className = 'status-value success';

            // æ˜¾ç¤ºç»“æœ
            document.getElementById('completionTime').textContent = new Date().toLocaleString();
            document.getElementById('successFrames').textContent = status.extracted_frames || 0;
            document.getElementById('archiveSize').textContent = status.archive_size || '-';
            document.getElementById('downloadLink').textContent = status.download_url || '-';

            // å¯ç”¨ä¸‹è½½æŒ‰é’®
            const downloadBtn = document.getElementById('downloadResultsBtn');
            if (status.download_url) {
                downloadBtn.disabled = false;
                downloadBtn.dataset.downloadUrl = status.download_url;
            }

            // æ˜¾ç¤ºä¸‰å¸§é¢„è§ˆ
            if (status.preview_frames) {
                log('ğŸ–¼ï¸ æ£€æµ‹åˆ°é¢„è§ˆå¸§æ•°æ®ï¼Œå¼€å§‹æ˜¾ç¤º...');
                showThreeFramePreview(status.preview_frames);
            } else {
                log('âš ï¸ æ²¡æœ‰æ£€æµ‹åˆ°é¢„è§ˆå¸§æ•°æ®');
                console.log('Status object keys:', Object.keys(status));
            }

            // æ˜¾ç¤ºç»“æœå¡ç‰‡
            document.getElementById('resultsCard').style.display = 'block';

            // é‡ç½®çŠ¶æ€
            resetExtractionState();

            log(`ğŸ“Š æå–ç»Ÿè®¡: æˆåŠŸæå– ${status.extracted_frames} å¸§`);
            if (status.download_url) {
                log(`ğŸ’¾ ä¸‹è½½é“¾æ¥: ${status.download_url}`);
            }
        }

        // é‡ç½®æå–çŠ¶æ€
        function resetExtractionState() {
            extractionInProgress = false;
            extractionTaskId = null;

            document.getElementById('startExtractionBtn').disabled = false;
            document.getElementById('stopExtractionBtn').disabled = true;

            if (document.getElementById('extractionStatus').textContent === 'æ­£åœ¨æå–...') {
                document.getElementById('extractionStatus').textContent = 'å¾…æœº';
                document.getElementById('extractionStatus').className = 'status-value';
            }
        }

        // ä¸‹è½½ç»“æœ
        function downloadResults() {
            const downloadBtn = document.getElementById('downloadResultsBtn');
            const downloadUrl = downloadBtn.dataset.downloadUrl;

            if (downloadUrl) {
                log('ğŸ’¾ å¼€å§‹ä¸‹è½½æå–ç»“æœ...');
                // åˆ›å»ºä¸€ä¸ªéšè—çš„ä¸‹è½½é“¾æ¥
                const link = document.createElement('a');
                link.href = downloadUrl;
                link.download = '';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                log('âœ… ä¸‹è½½å·²å¼€å§‹');
            } else {
                log('âŒ æ²¡æœ‰å¯ç”¨çš„ä¸‹è½½é“¾æ¥', 'error');
            }
        }
    </script>
</body>
</html>
