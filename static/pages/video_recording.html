<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¬ è§†é¢‘å½•åˆ¶ - æ·±è§†è¾¹ç¼˜è§†è§‰å¹³å°</title>
    <link rel="stylesheet" href="/static/css/unified-style.css">
    <style>
        /* é¡µé¢ç‰¹å®šæ ·å¼ - å½•åˆ¶ç›¸å…³ */
        .recording-indicator {
            position: absolute;
            top: 15px;
            left: 15px;
            background: #ff4444;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: bold;
            display: none;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .status-panel {
            display: grid;
            grid-template-columns: 1fr;
            gap: 8px;
            margin: 16px 0;
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
        }

        .status-label {
            font-weight: 500;
            color: rgba(127, 140, 141, 0.8);
        }

        .status-value {
            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
            font-weight: 600;
            color: rgba(44, 62, 80, 0.9);
        }

        .video-list {
            max-height: 300px;
            overflow-y: auto;
        }


    </style>
</head>
<body>
    <div class="app-container">
        <!-- é¡¶éƒ¨å¯¼èˆª -->
        <div id="navigation-container"></div>

        <!-- é¡µé¢æ ‡é¢˜ -->
        <header class="page-header">
            <h1 class="page-title">Video Recording</h1>
            <p class="page-subtitle">DeepVision Edge Platform - Professional camera recording with real-time preview</p>
        </header>

        <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
        <div class="grid grid-2">
            <!-- å·¦ä¾§ï¼šè§†é¢‘é¢„è§ˆå’Œæ‘„åƒå¤´æ§åˆ¶ -->
            <div class="card fade-in">
                <div class="card-header">
                    <h3 class="card-title">ğŸ“¹ æ‘„åƒå¤´é¢„è§ˆ</h3>
                </div>

                <!-- è§†é¢‘é¢„è§ˆ -->
                <div class="video-container" style="background: #000; border-radius: 8px; overflow: hidden; position: relative; margin-bottom: 20px;">
                    <canvas id="videoCanvas" width="640" height="480" style="width: 100%; height: auto; display: block;"></canvas>
                    <div id="recordingIndicator" class="recording-indicator">
                        ğŸ”´ å½•åˆ¶ä¸­
                    </div>
                </div>

                <!-- æ‘„åƒå¤´æ§åˆ¶ -->
                <div class="form-group">
                    <label class="form-label">æ‘„åƒå¤´è®¾å¤‡:</label>
                    <select class="form-select" id="deviceSelect">
                        <option value="/dev/video0">æ‘„åƒå¤´ 0 (/dev/video0)</option>
                        <option value="/dev/video2">æ‘„åƒå¤´ 1 (/dev/video2)</option>
                    </select>
                </div>

                <div class="control-row">
                    <button id="connectBtn" class="btn btn-primary">è¿æ¥</button>
                    <button id="disconnectBtn" class="btn btn-danger" disabled>æ–­å¼€</button>
                    <button id="startCameraBtn" class="btn btn-success" disabled>å¯åŠ¨æ‘„åƒå¤´</button>
                    <button id="stopCameraBtn" class="btn btn-warning" disabled>åœæ­¢æ‘„åƒå¤´</button>
                </div>
            </div>

            <!-- å³ä¾§ï¼šå½•åˆ¶æ§åˆ¶é¢æ¿ -->
            <div class="card fade-in">
                <div class="card-header">
                    <h3 class="card-title">ğŸ¬ å½•åˆ¶æ§åˆ¶</h3>
                </div>

                <!-- å½•åˆ¶å‚æ•°è®¾ç½® -->
                <div class="form-group">
                    <label class="form-label">å½•åˆ¶åˆ†è¾¨ç‡:</label>
                    <select class="form-select" id="recordingResolution">
                        <option value="640x480" selected>640x480 (VGA)</option>
                        <option value="800x600">800x600 (SVGA)</option>
                        <option value="1024x768">1024x768 (XGA)</option>
                        <option value="1280x720">1280x720 (HD)</option>
                        <option value="1280x960">1280x960 (SXGA)</option>
                        <option value="1920x1080">1920x1080 (Full HD)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">å½•åˆ¶å¸§ç‡:</label>
                    <select class="form-select" id="recordingFps">
                        <option value="15">15 FPS</option>
                        <option value="24">24 FPS</option>
                        <option value="30" selected>30 FPS</option>
                        <option value="60">60 FPS</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">æ–‡ä»¶å (å¯é€‰):</label>
                    <input type="text" class="form-input" id="recordingFilename" placeholder="ç•™ç©ºè‡ªåŠ¨ç”Ÿæˆ">
                </div>

                <!-- å½•åˆ¶æ§åˆ¶æŒ‰é’® -->
                <div class="control-row">
                    <button id="startRecordingBtn" class="btn btn-success" disabled>ğŸ¬ å¼€å§‹å½•åˆ¶</button>
                    <button id="stopRecordingBtn" class="btn btn-danger" disabled>ğŸ›‘ åœæ­¢å½•åˆ¶</button>
                </div>

                <div class="control-row">
                    <button id="getRecordingStatusBtn" class="btn btn-primary" disabled>ğŸ“Š å½•åˆ¶çŠ¶æ€</button>
                    <button id="getStatusBtn" class="btn btn-secondary" disabled>ğŸ“‹ è®¾å¤‡çŠ¶æ€</button>
                </div>

                <!-- å½•åˆ¶çŠ¶æ€æ˜¾ç¤º -->
                <div style="margin-top: 24px;">
                    <h4 style="margin-bottom: 12px; color: rgba(44, 62, 80, 0.9);">ğŸ“Š å½•åˆ¶çŠ¶æ€</h4>
                    <div class="status-panel">
                        <div class="status-item">
                            <span class="status-label">çŠ¶æ€:</span>
                            <span id="statusRecording" class="status-value">æœªå½•åˆ¶</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">æ—¶é•¿:</span>
                            <span id="statusDuration" class="status-value">00:00:00</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">å¸§æ•°:</span>
                            <span id="statusFrameCount" class="status-value">0</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">æ–‡ä»¶å¤§å°:</span>
                            <span id="statusFileSize" class="status-value">0 MB</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">å½“å‰æ–‡ä»¶:</span>
                            <span id="statusFilename" class="status-value">-</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- å½•åˆ¶å†å² -->
        <div class="card fade-in" style="margin-top: 32px;">
            <div class="card-header">
                <h3 class="card-title">ğŸï¸ å½•åˆ¶å†å²</h3>
                <button id="refreshVideoListBtn" class="btn btn-primary">ğŸ”„ åˆ·æ–°åˆ—è¡¨</button>
            </div>
            <div id="videoList" class="video-list">
                <p style="text-align: center; color: rgba(127, 140, 141, 0.7); padding: 20px;">ç‚¹å‡»"åˆ·æ–°åˆ—è¡¨"åŠ è½½å½•åˆ¶å†å²</p>
            </div>
        </div>

        <!-- æ—¥å¿—åŒºåŸŸ -->
        <div class="card fade-in" style="margin-top: 32px;">
            <div class="card-header">
                <h3 class="card-title">ğŸ“‹ ç³»ç»Ÿæ—¥å¿—</h3>
                <button id="clearLogBtn" class="btn btn-warning">æ¸…ç©ºæ—¥å¿—</button>
            </div>
            <div class="log-content" id="logContent"></div>
        </div>
    </div>

    <script src="/static/js/navigation.js"></script>
    <script>
        // DOMå…ƒç´ 
        const connectBtn = document.getElementById('connectBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');
        const startCameraBtn = document.getElementById('startCameraBtn');
        const stopCameraBtn = document.getElementById('stopCameraBtn');
        const getStatusBtn = document.getElementById('getStatusBtn');
        const startRecordingBtn = document.getElementById('startRecordingBtn');
        const stopRecordingBtn = document.getElementById('stopRecordingBtn');
        const getRecordingStatusBtn = document.getElementById('getRecordingStatusBtn');
        const refreshVideoListBtn = document.getElementById('refreshVideoListBtn');
        const clearLogBtn = document.getElementById('clearLogBtn');

        const deviceSelect = document.getElementById('deviceSelect');
        const recordingResolution = document.getElementById('recordingResolution');
        const recordingFps = document.getElementById('recordingFps');
        const recordingFilename = document.getElementById('recordingFilename');

        const recordingIndicator = document.getElementById('recordingIndicator');
        const statusRecording = document.getElementById('statusRecording');
        const statusDuration = document.getElementById('statusDuration');
        const statusFrameCount = document.getElementById('statusFrameCount');
        const statusFileSize = document.getElementById('statusFileSize');
        const statusFilename = document.getElementById('statusFilename');
        const videoList = document.getElementById('videoList');
        const logContent = document.getElementById('logContent');
        const videoCanvas = document.getElementById('videoCanvas');
        const ctx = videoCanvas.getContext('2d');

        // WebSocketè¿æ¥
        let ws = null;
        let receivedFrames = 0;
        let isRecording = false;
        let recordingStartTime = null;
        let statusUpdateInterval = null;

        // æ—¥å¿—å‡½æ•°
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}\n`;
            logContent.textContent += logEntry;
            logContent.scrollTop = logContent.scrollHeight;

            // æ§åˆ¶å°ä¹Ÿè¾“å‡º
            console.log(`[${timestamp}] ${type.toUpperCase()}: ${message}`);
        }

        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        function updateButtons(connected) {
            connectBtn.disabled = connected;
            disconnectBtn.disabled = !connected;
            startCameraBtn.disabled = !connected;
            stopCameraBtn.disabled = !connected;
            getStatusBtn.disabled = !connected;
            startRecordingBtn.disabled = !connected || isRecording;
            stopRecordingBtn.disabled = !connected || !isRecording;
            getRecordingStatusBtn.disabled = !connected;
        }

        // æ›´æ–°å½•åˆ¶çŠ¶æ€æ˜¾ç¤º
        function updateRecordingStatus(recording, duration = 0, frameCount = 0, fileSize = 0, filename = '') {
            isRecording = recording;

            statusRecording.textContent = recording ? 'å½•åˆ¶ä¸­' : 'æœªå½•åˆ¶';
            statusRecording.style.color = recording ? '#dc3545' : '#6c757d';

            // æ˜¾ç¤º/éšè—å½•åˆ¶æŒ‡ç¤ºå™¨
            recordingIndicator.style.display = recording ? 'block' : 'none';

            // æ ¼å¼åŒ–æ—¶é•¿
            const hours = Math.floor(duration / 3600);
            const minutes = Math.floor((duration % 3600) / 60);
            const seconds = duration % 60;
            statusDuration.textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

            statusFrameCount.textContent = frameCount.toString();
            statusFileSize.textContent = (fileSize / (1024 * 1024)).toFixed(2) + ' MB';
            statusFilename.textContent = filename || '-';

            updateButtons(ws && ws.readyState === WebSocket.OPEN);
        }

        // WebSocketè¿æ¥
        function connectWebSocket() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                log('WebSocketå·²ç»è¿æ¥', 'warning');
                return;
            }

            log('æ­£åœ¨è¿æ¥WebSocketè§†é¢‘æµæœåŠ¡å™¨...');
            ws = new WebSocket('ws://localhost:8081/ws/video');

            ws.onopen = function() {
                log('âœ… WebSocketè¿æ¥æˆåŠŸ');
                updateButtons(true);
            };

            ws.onclose = function() {
                log('âŒ WebSocketè¿æ¥å·²å…³é—­');
                updateButtons(false);
                updateRecordingStatus(false);
                if (statusUpdateInterval) {
                    clearInterval(statusUpdateInterval);
                    statusUpdateInterval = null;
                }
            };

            ws.onerror = function(error) {
                log('âŒ WebSocketè¿æ¥é”™è¯¯: ' + error, 'error');
                updateButtons(false);
            };

            ws.onmessage = function(event) {
                if (event.data instanceof ArrayBuffer) {
                    handleVideoFrame(event.data);
                } else if (typeof event.data === 'string') {
                    handleTextMessage(event.data);
                }
            };
        }

        // æ–­å¼€WebSocket
        function disconnectWebSocket() {
            if (ws) {
                ws.close();
                ws = null;
            }
            updateButtons(false);
            updateRecordingStatus(false);
        }

        // å¤„ç†æ–‡æœ¬æ¶ˆæ¯
        function handleTextMessage(data) {
            try {
                const message = JSON.parse(data);
                log('ğŸ“¨ æ”¶åˆ°æ¶ˆæ¯: ' + JSON.stringify(message));

                switch (message.type) {
                    case 'welcome':
                        log('ğŸ‰ ' + message.message);
                        break;
                    case 'success':
                        log('âœ… ' + message.message);
                        break;
                    case 'error':
                        log('âŒ ' + message.message, 'error');
                        break;
                    case 'recording_started':
                        handleRecordingStarted(message);
                        break;
                    case 'recording_stopped':
                        handleRecordingStopped(message);
                        break;
                    case 'recording_status':
                        handleRecordingStatusUpdate(message);
                        break;
                    default:
                        log('ğŸ“‹ æœªçŸ¥æ¶ˆæ¯ç±»å‹: ' + message.type);
                }
            } catch (e) {
                log('âŒ è§£ææ¶ˆæ¯å¤±è´¥: ' + e.message, 'error');
            }
        }

        // å¤„ç†è§†é¢‘å¸§
        function handleVideoFrame(arrayBuffer) {
            receivedFrames++;

            try {
                const blob = new Blob([arrayBuffer], { type: 'image/jpeg' });
                const url = URL.createObjectURL(blob);
                const img = new Image();

                img.onload = function() {
                    ctx.clearRect(0, 0, videoCanvas.width, videoCanvas.height);
                    ctx.drawImage(img, 0, 0, videoCanvas.width, videoCanvas.height);
                    URL.revokeObjectURL(url);
                };

                img.onerror = function() {
                    URL.revokeObjectURL(url);
                };

                img.src = url;

            } catch (e) {
                log('âŒ å¤„ç†è§†é¢‘å¸§å¤±è´¥: ' + e.message, 'error');
            }
        }

        // å‘é€å‘½ä»¤
        function sendCommand(action, params = {}) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                const command = { action, ...params };
                const commandStr = JSON.stringify(command);
                ws.send(commandStr);
                log('ğŸ“¤ å‘é€å‘½ä»¤: ' + commandStr);
                return true;
            } else {
                log('âŒ WebSocketæœªè¿æ¥', 'error');
                return false;
            }
        }

        // æ‘„åƒå¤´æ§åˆ¶
        function startCamera() {
            sendCommand('start_camera', { device: deviceSelect.value });
        }

        function stopCamera() {
            sendCommand('stop_camera');
        }

        function getStatus() {
            sendCommand('get_status');
        }

        // å½•åˆ¶æ§åˆ¶
        function startRecording() {
            const device = deviceSelect.value;
            const resolution = recordingResolution.value;
            const fps = parseInt(recordingFps.value);
            const filename = recordingFilename.value.trim();

            const [width, height] = resolution.split('x').map(Number);

            const params = {
                device: device,
                width: width,
                height: height,
                fps: fps
            };

            if (filename) {
                params.filename = filename.endsWith('.mjpeg') ? filename : filename + '.mjpeg';
            }

            if (sendCommand('start_recording', params)) {
                recordingStartTime = Date.now();
                // å¼€å§‹å®šæ—¶æ›´æ–°å½•åˆ¶çŠ¶æ€
                statusUpdateInterval = setInterval(getRecordingStatus, 1000);
            }
        }

        function stopRecording() {
            log('ğŸ›‘ æ­£åœ¨åœæ­¢å½•åˆ¶å¹¶å…³é—­æ‘„åƒå¤´...');
            sendCommand('stop_recording');
            if (statusUpdateInterval) {
                clearInterval(statusUpdateInterval);
                statusUpdateInterval = null;
            }
        }

        function getRecordingStatus() {
            sendCommand('get_recording_status');
        }

        // å¤„ç†å½•åˆ¶ç›¸å…³æ¶ˆæ¯
        function handleRecordingStarted(message) {
            log('ğŸ¬ å½•åˆ¶å¼€å§‹: ' + message.filename);
            updateRecordingStatus(true, 0, 0, 0, message.filename);
            recordingFilename.value = ''; // æ¸…ç©ºæ–‡ä»¶åè¾“å…¥
        }

        function handleRecordingStopped(message) {
            log('ğŸ›‘ å½•åˆ¶åœæ­¢: ' + message.filename + ' (æ—¶é•¿: ' + message.duration + 's, å¸§æ•°: ' + message.frame_count + ')');
            updateRecordingStatus(false, message.duration, message.frame_count, message.file_size, message.filename);

            // å½•åˆ¶åœæ­¢åè‡ªåŠ¨å…³é—­æ‘„åƒå¤´
            setTimeout(() => {
                log('ğŸ“¹ è‡ªåŠ¨å…³é—­æ‘„åƒå¤´...');
                sendCommand('stop_camera');
            }, 1000); // å»¶è¿Ÿ1ç§’ç¡®ä¿å½•åˆ¶å®Œå…¨åœæ­¢

            refreshVideoList(); // åˆ·æ–°è§†é¢‘åˆ—è¡¨
        }

        function handleRecordingStatusUpdate(message) {
            if (message.is_recording) {
                updateRecordingStatus(true, message.duration, message.frame_count, message.file_size, message.filename);
            } else {
                updateRecordingStatus(false);
            }
        }

        // åˆ·æ–°è§†é¢‘åˆ—è¡¨
        function refreshVideoList() {
            fetch('/api/videos')
                .then(response => response.json())
                .then(data => {
                    displayVideoList(data.videos);
                })
                .catch(error => {
                    log('âŒ è·å–è§†é¢‘åˆ—è¡¨å¤±è´¥: ' + error.message, 'error');
                    videoList.innerHTML = '<p style="text-align: center; color: #dc3545; padding: 20px;">è·å–è§†é¢‘åˆ—è¡¨å¤±è´¥</p>';
                });
        }

        // æ˜¾ç¤ºè§†é¢‘åˆ—è¡¨
        function displayVideoList(videos) {
            if (videos.length === 0) {
                videoList.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">æš‚æ— å½•åˆ¶çš„è§†é¢‘</p>';
                return;
            }

            let html = '';
            videos.forEach(video => {
                const date = new Date(video.timestamp * 1000).toLocaleString();
                const size = (video.size / (1024 * 1024)).toFixed(2);

                html += `
                    <div class="video-item">
                        <div style="font-weight: bold; margin-bottom: 5px;">${video.filename}</div>
                        <div class="video-info">
                            ğŸ“… ${date} | ğŸ“¦ ${size} MB
                        </div>
                        <div class="video-actions">
                            <button class="btn btn-primary btn-small" onclick="playVideo('${video.url}')">â–¶ï¸ æ’­æ”¾</button>
                            <button class="btn btn-success btn-small" onclick="downloadVideo('${video.download_url}', '${video.filename}')">ğŸ’¾ ä¸‹è½½</button>
                        </div>
                    </div>
                `;
            });

            videoList.innerHTML = html;
        }

        // æ’­æ”¾è§†é¢‘
        function playVideo(url) {
            window.open(url, '_blank');
            log('â–¶ï¸ åœ¨æ–°çª—å£ä¸­æ’­æ”¾è§†é¢‘');
        }

        // ä¸‹è½½è§†é¢‘
        function downloadVideo(downloadUrl, filename) {
            const link = document.createElement('a');
            link.href = downloadUrl;
            link.download = filename;
            link.style.display = 'none';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            log('ğŸ’¾ å¼€å§‹ä¸‹è½½è§†é¢‘: ' + filename);
        }

        // æ¸…ç©ºæ—¥å¿—
        function clearLog() {
            logContent.textContent = '';
            receivedFrames = 0;
            log('æ—¥å¿—å·²æ¸…ç©º');
        }

        // äº‹ä»¶ç›‘å¬å™¨
        connectBtn.addEventListener('click', connectWebSocket);
        disconnectBtn.addEventListener('click', disconnectWebSocket);
        startCameraBtn.addEventListener('click', startCamera);
        stopCameraBtn.addEventListener('click', stopCamera);
        getStatusBtn.addEventListener('click', getStatus);
        startRecordingBtn.addEventListener('click', startRecording);
        stopRecordingBtn.addEventListener('click', stopRecording);
        getRecordingStatusBtn.addEventListener('click', getRecordingStatus);
        refreshVideoListBtn.addEventListener('click', refreshVideoList);
        clearLogBtn.addEventListener('click', clearLog);

        // é¡µé¢åŠ è½½å®Œæˆ
        document.addEventListener('DOMContentLoaded', function() {
            log('ğŸ¬ è§†é¢‘å½•åˆ¶é¡µé¢å·²åŠ è½½');
            log('ç‚¹å‡»"è¿æ¥"å¼€å§‹ä½¿ç”¨å½•åˆ¶åŠŸèƒ½');
            updateButtons(false);
            updateRecordingStatus(false);
        });
    </script>
</body>
</html>
