<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocketæ‘„åƒå¤´æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .control-panel {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }
        .btn-primary {
            background-color: #007bff;
            color: white;
        }
        .btn-primary:hover {
            background-color: #0056b3;
        }
        .btn-success {
            background-color: #28a745;
            color: white;
        }
        .btn-success:hover {
            background-color: #1e7e34;
        }
        .btn-danger {
            background-color: #dc3545;
            color: white;
        }
        .btn-danger:hover {
            background-color: #c82333;
        }
        .btn-warning {
            background-color: #ffc107;
            color: #212529;
        }
        .btn-warning:hover {
            background-color: #e0a800;
        }
        .status-panel {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .status-item {
            margin-bottom: 10px;
            font-family: 'Courier New', monospace;
        }
        .status-label {
            font-weight: bold;
            display: inline-block;
            width: 150px;
        }
        .status-connected {
            color: #28a745;
        }
        .status-disconnected {
            color: #dc3545;
        }
        .status-connecting {
            color: #ffc107;
        }
        .video-panel {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        .video-container {
            flex: 1;
            min-width: 300px;
        }
        .video-title {
            font-weight: bold;
            margin-bottom: 10px;
            padding: 10px;
            background-color: #e9ecef;
            border-radius: 4px;
        }
        canvas {
            width: 100%;
            max-width: 640px;
            height: auto;
            border: 2px solid #dee2e6;
            border-radius: 4px;
            background-color: #000;
        }
        .log-panel {
            margin-top: 20px;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
        }
        .log-title {
            font-weight: bold;
            margin-bottom: 10px;
        }
        .log-content {
            font-family: 'Courier New', monospace;
            font-size: 12px;
            white-space: pre-wrap;
            background-color: #000;
            color: #00ff00;
            padding: 10px;
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¥ WebSocketæ‘„åƒå¤´æµ‹è¯•</h1>
        
        <!-- æ§åˆ¶é¢æ¿ -->
        <div class="control-panel">
            <button id="connectBtn" class="btn-primary">è¿æ¥WebSocket</button>
            <button id="disconnectBtn" class="btn-danger" disabled>æ–­å¼€è¿æ¥</button>
            <button id="startCameraBtn" class="btn-success" disabled>å¯åŠ¨æ‘„åƒå¤´</button>
            <button id="stopCameraBtn" class="btn-warning" disabled>åœæ­¢æ‘„åƒå¤´</button>
            <button id="clearLogBtn" class="btn-warning">æ¸…ç©ºæ—¥å¿—</button>
        </div>

        <!-- çŠ¶æ€é¢æ¿ -->
        <div class="status-panel">
            <div class="status-item">
                <span class="status-label">WebSocketçŠ¶æ€:</span>
                <span id="wsStatus" class="status-disconnected">æœªè¿æ¥</span>
            </div>
            <div class="status-item">
                <span class="status-label">æœåŠ¡å™¨åœ°å€:</span>
                <span id="serverAddress">ws://192.168.124.12:8080/ws/camera</span>
            </div>
            <div class="status-item">
                <span class="status-label">æ¥æ”¶å¸§æ•°:</span>
                <span id="frameCount">0</span>
            </div>
            <div class="status-item">
                <span class="status-label">å¸§ç‡ (FPS):</span>
                <span id="fps">0</span>
            </div>
            <div class="status-item">
                <span class="status-label">è¿æ¥æ—¶é•¿:</span>
                <span id="connectionTime">00:00:00</span>
            </div>
        </div>

        <!-- è§†é¢‘æ˜¾ç¤ºé¢æ¿ -->
        <div class="video-panel">
            <div class="video-container">
                <div class="video-title">ğŸ“¹ æ‘„åƒå¤´è§†é¢‘æµ</div>
                <canvas id="videoCanvas" width="640" height="480"></canvas>
            </div>
        </div>

        <!-- æ—¥å¿—é¢æ¿ -->
        <div class="log-panel">
            <div class="log-title">ğŸ“‹ è°ƒè¯•æ—¥å¿—</div>
            <div id="logContent" class="log-content"></div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let ws = null;
        let frameCount = 0;
        let startTime = null;
        let fpsInterval = null;
        let connectionTimeInterval = null;
        let lastFrameTime = 0;

        // DOMå…ƒç´ 
        const connectBtn = document.getElementById('connectBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');
        const startCameraBtn = document.getElementById('startCameraBtn');
        const stopCameraBtn = document.getElementById('stopCameraBtn');
        const clearLogBtn = document.getElementById('clearLogBtn');
        const wsStatus = document.getElementById('wsStatus');
        const serverAddress = document.getElementById('serverAddress');
        const frameCountElement = document.getElementById('frameCount');
        const fpsElement = document.getElementById('fps');
        const connectionTimeElement = document.getElementById('connectionTime');
        const logContent = document.getElementById('logContent');
        const videoCanvas = document.getElementById('videoCanvas');
        const ctx = videoCanvas.getContext('2d');

        // æ—¥å¿—å‡½æ•°
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logLine = `[${timestamp}] ${type.toUpperCase()}: ${message}\n`;
            logContent.textContent += logLine;
            logContent.scrollTop = logContent.scrollHeight;
            console.log(logLine);
        }

        // æ›´æ–°çŠ¶æ€
        function updateStatus(status, className) {
            wsStatus.textContent = status;
            wsStatus.className = className;
        }

        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        function updateButtons(connected) {
            connectBtn.disabled = connected;
            disconnectBtn.disabled = !connected;
            startCameraBtn.disabled = !connected;
            stopCameraBtn.disabled = !connected;
        }

        // æ›´æ–°è¿æ¥æ—¶é•¿
        function updateConnectionTime() {
            if (startTime) {
                const elapsed = Date.now() - startTime;
                const hours = Math.floor(elapsed / 3600000);
                const minutes = Math.floor((elapsed % 3600000) / 60000);
                const seconds = Math.floor((elapsed % 60000) / 1000);
                connectionTimeElement.textContent = 
                    `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
        }

        // è®¡ç®—FPS
        function updateFPS() {
            const now = Date.now();
            if (lastFrameTime > 0) {
                const fps = 1000 / (now - lastFrameTime);
                fpsElement.textContent = fps.toFixed(1);
            }
            lastFrameTime = now;
        }

        // è¿æ¥WebSocket
        function connectWebSocket() {
            const url = serverAddress.textContent;
            log(`æ­£åœ¨è¿æ¥åˆ°: ${url}`);
            updateStatus('è¿æ¥ä¸­...', 'status-connecting');

            try {
                ws = new WebSocket(url);
                ws.binaryType = 'arraybuffer';

                ws.onopen = function(event) {
                    log('WebSocketè¿æ¥å·²å»ºç«‹', 'success');
                    updateStatus('å·²è¿æ¥', 'status-connected');
                    updateButtons(true);
                    startTime = Date.now();
                    connectionTimeInterval = setInterval(updateConnectionTime, 1000);
                };

                ws.onmessage = function(event) {
                    if (event.data instanceof ArrayBuffer) {
                        // å¤„ç†äºŒè¿›åˆ¶æ•°æ®ï¼ˆJPEGå›¾åƒï¼‰
                        frameCount++;
                        frameCountElement.textContent = frameCount;
                        updateFPS();
                        
                        // å°†ArrayBufferè½¬æ¢ä¸ºBlobï¼Œç„¶åæ˜¾ç¤ºå›¾åƒ
                        const blob = new Blob([event.data], {type: 'image/jpeg'});
                        const url = URL.createObjectURL(blob);
                        const img = new Image();
                        img.onload = function() {
                            ctx.drawImage(img, 0, 0, videoCanvas.width, videoCanvas.height);
                            URL.revokeObjectURL(url);
                        };
                        img.src = url;
                        
                        if (frameCount % 30 === 0) { // æ¯30å¸§è®°å½•ä¸€æ¬¡
                            log(`å·²æ¥æ”¶ ${frameCount} å¸§å›¾åƒæ•°æ®`);
                        }
                    } else {
                        // å¤„ç†æ–‡æœ¬æ¶ˆæ¯
                        log(`æ”¶åˆ°æ–‡æœ¬æ¶ˆæ¯: ${event.data}`);
                    }
                };

                ws.onclose = function(event) {
                    log(`WebSocketè¿æ¥å·²å…³é—­: ä»£ç =${event.code}, åŸå› =${event.reason}`, 'warning');
                    updateStatus('å·²æ–­å¼€', 'status-disconnected');
                    updateButtons(false);
                    if (connectionTimeInterval) {
                        clearInterval(connectionTimeInterval);
                        connectionTimeInterval = null;
                    }
                    ws = null;
                };

                ws.onerror = function(error) {
                    log(`WebSocketé”™è¯¯: ${error}`, 'error');
                    updateStatus('è¿æ¥é”™è¯¯', 'status-disconnected');
                    updateButtons(false);
                };

            } catch (error) {
                log(`è¿æ¥å¤±è´¥: ${error.message}`, 'error');
                updateStatus('è¿æ¥å¤±è´¥', 'status-disconnected');
                updateButtons(false);
            }
        }

        // æ–­å¼€WebSocket
        function disconnectWebSocket() {
            if (ws) {
                log('æ­£åœ¨æ–­å¼€WebSocketè¿æ¥...');
                ws.close();
            }
        }

        // å¯åŠ¨æ‘„åƒå¤´
        function startCamera() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                log('å‘é€å¯åŠ¨æ‘„åƒå¤´å‘½ä»¤');
                ws.send(JSON.stringify({
                    action: 'start_camera',
                    camera_id: 'default'
                }));
            }
        }

        // åœæ­¢æ‘„åƒå¤´
        function stopCamera() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                log('å‘é€åœæ­¢æ‘„åƒå¤´å‘½ä»¤');
                ws.send(JSON.stringify({
                    action: 'stop_camera',
                    camera_id: 'default'
                }));
            }
        }

        // æ¸…ç©ºæ—¥å¿—
        function clearLog() {
            logContent.textContent = '';
            frameCount = 0;
            frameCountElement.textContent = '0';
            fpsElement.textContent = '0';
            log('æ—¥å¿—å·²æ¸…ç©º');
        }

        // äº‹ä»¶ç›‘å¬å™¨
        connectBtn.addEventListener('click', connectWebSocket);
        disconnectBtn.addEventListener('click', disconnectWebSocket);
        startCameraBtn.addEventListener('click', startCamera);
        stopCameraBtn.addEventListener('click', stopCamera);
        clearLogBtn.addEventListener('click', clearLog);

        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            log('WebSocketæ‘„åƒå¤´æµ‹è¯•é¡µé¢å·²åŠ è½½');
            log('ç‚¹å‡»"è¿æ¥WebSocket"å¼€å§‹æµ‹è¯•');
        });

        // é¡µé¢å¸è½½æ—¶æ¸…ç†
        window.addEventListener('beforeunload', function() {
            if (ws) {
                ws.close();
            }
        });
    </script>
</body>
</html>
