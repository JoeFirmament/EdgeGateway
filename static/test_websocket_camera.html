<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket摄像头测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .control-panel {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }
        .btn-primary {
            background-color: #007bff;
            color: white;
        }
        .btn-primary:hover {
            background-color: #0056b3;
        }
        .btn-success {
            background-color: #28a745;
            color: white;
        }
        .btn-success:hover {
            background-color: #1e7e34;
        }
        .btn-danger {
            background-color: #dc3545;
            color: white;
        }
        .btn-danger:hover {
            background-color: #c82333;
        }
        .btn-warning {
            background-color: #ffc107;
            color: #212529;
        }
        .btn-warning:hover {
            background-color: #e0a800;
        }
        .status-panel {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .status-item {
            margin-bottom: 10px;
            font-family: 'Courier New', monospace;
        }
        .status-label {
            font-weight: bold;
            display: inline-block;
            width: 150px;
        }
        .status-connected {
            color: #28a745;
        }
        .status-disconnected {
            color: #dc3545;
        }
        .status-connecting {
            color: #ffc107;
        }
        .video-panel {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        .video-container {
            flex: 1;
            min-width: 300px;
        }
        .video-title {
            font-weight: bold;
            margin-bottom: 10px;
            padding: 10px;
            background-color: #e9ecef;
            border-radius: 4px;
        }
        canvas {
            width: 100%;
            max-width: 640px;
            height: auto;
            border: 2px solid #dee2e6;
            border-radius: 4px;
            background-color: #000;
        }
        .log-panel {
            margin-top: 20px;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
        }
        .log-title {
            font-weight: bold;
            margin-bottom: 10px;
        }
        .log-content {
            font-family: 'Courier New', monospace;
            font-size: 12px;
            white-space: pre-wrap;
            background-color: #000;
            color: #00ff00;
            padding: 10px;
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🎥 WebSocket摄像头测试</h1>
        
        <!-- 控制面板 -->
        <div class="control-panel">
            <button id="connectBtn" class="btn-primary">连接WebSocket</button>
            <button id="disconnectBtn" class="btn-danger" disabled>断开连接</button>
            <button id="startCameraBtn" class="btn-success" disabled>启动摄像头</button>
            <button id="stopCameraBtn" class="btn-warning" disabled>停止摄像头</button>
            <button id="clearLogBtn" class="btn-warning">清空日志</button>
        </div>

        <!-- 状态面板 -->
        <div class="status-panel">
            <div class="status-item">
                <span class="status-label">WebSocket状态:</span>
                <span id="wsStatus" class="status-disconnected">未连接</span>
            </div>
            <div class="status-item">
                <span class="status-label">服务器地址:</span>
                <span id="serverAddress">ws://192.168.124.12:8080/ws/camera</span>
            </div>
            <div class="status-item">
                <span class="status-label">接收帧数:</span>
                <span id="frameCount">0</span>
            </div>
            <div class="status-item">
                <span class="status-label">帧率 (FPS):</span>
                <span id="fps">0</span>
            </div>
            <div class="status-item">
                <span class="status-label">连接时长:</span>
                <span id="connectionTime">00:00:00</span>
            </div>
        </div>

        <!-- 视频显示面板 -->
        <div class="video-panel">
            <div class="video-container">
                <div class="video-title">📹 摄像头视频流</div>
                <canvas id="videoCanvas" width="640" height="480"></canvas>
            </div>
        </div>

        <!-- 日志面板 -->
        <div class="log-panel">
            <div class="log-title">📋 调试日志</div>
            <div id="logContent" class="log-content"></div>
        </div>
    </div>

    <script>
        // 全局变量
        let ws = null;
        let frameCount = 0;
        let startTime = null;
        let fpsInterval = null;
        let connectionTimeInterval = null;
        let lastFrameTime = 0;

        // DOM元素
        const connectBtn = document.getElementById('connectBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');
        const startCameraBtn = document.getElementById('startCameraBtn');
        const stopCameraBtn = document.getElementById('stopCameraBtn');
        const clearLogBtn = document.getElementById('clearLogBtn');
        const wsStatus = document.getElementById('wsStatus');
        const serverAddress = document.getElementById('serverAddress');
        const frameCountElement = document.getElementById('frameCount');
        const fpsElement = document.getElementById('fps');
        const connectionTimeElement = document.getElementById('connectionTime');
        const logContent = document.getElementById('logContent');
        const videoCanvas = document.getElementById('videoCanvas');
        const ctx = videoCanvas.getContext('2d');

        // 日志函数
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logLine = `[${timestamp}] ${type.toUpperCase()}: ${message}\n`;
            logContent.textContent += logLine;
            logContent.scrollTop = logContent.scrollHeight;
            console.log(logLine);
        }

        // 更新状态
        function updateStatus(status, className) {
            wsStatus.textContent = status;
            wsStatus.className = className;
        }

        // 更新按钮状态
        function updateButtons(connected) {
            connectBtn.disabled = connected;
            disconnectBtn.disabled = !connected;
            startCameraBtn.disabled = !connected;
            stopCameraBtn.disabled = !connected;
        }

        // 更新连接时长
        function updateConnectionTime() {
            if (startTime) {
                const elapsed = Date.now() - startTime;
                const hours = Math.floor(elapsed / 3600000);
                const minutes = Math.floor((elapsed % 3600000) / 60000);
                const seconds = Math.floor((elapsed % 60000) / 1000);
                connectionTimeElement.textContent = 
                    `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
        }

        // 计算FPS
        function updateFPS() {
            const now = Date.now();
            if (lastFrameTime > 0) {
                const fps = 1000 / (now - lastFrameTime);
                fpsElement.textContent = fps.toFixed(1);
            }
            lastFrameTime = now;
        }

        // 连接WebSocket
        function connectWebSocket() {
            const url = serverAddress.textContent;
            log(`正在连接到: ${url}`);
            updateStatus('连接中...', 'status-connecting');

            try {
                ws = new WebSocket(url);
                ws.binaryType = 'arraybuffer';

                ws.onopen = function(event) {
                    log('WebSocket连接已建立', 'success');
                    updateStatus('已连接', 'status-connected');
                    updateButtons(true);
                    startTime = Date.now();
                    connectionTimeInterval = setInterval(updateConnectionTime, 1000);
                };

                ws.onmessage = function(event) {
                    if (event.data instanceof ArrayBuffer) {
                        // 处理二进制数据（JPEG图像）
                        frameCount++;
                        frameCountElement.textContent = frameCount;
                        updateFPS();
                        
                        // 将ArrayBuffer转换为Blob，然后显示图像
                        const blob = new Blob([event.data], {type: 'image/jpeg'});
                        const url = URL.createObjectURL(blob);
                        const img = new Image();
                        img.onload = function() {
                            ctx.drawImage(img, 0, 0, videoCanvas.width, videoCanvas.height);
                            URL.revokeObjectURL(url);
                        };
                        img.src = url;
                        
                        if (frameCount % 30 === 0) { // 每30帧记录一次
                            log(`已接收 ${frameCount} 帧图像数据`);
                        }
                    } else {
                        // 处理文本消息
                        log(`收到文本消息: ${event.data}`);
                    }
                };

                ws.onclose = function(event) {
                    log(`WebSocket连接已关闭: 代码=${event.code}, 原因=${event.reason}`, 'warning');
                    updateStatus('已断开', 'status-disconnected');
                    updateButtons(false);
                    if (connectionTimeInterval) {
                        clearInterval(connectionTimeInterval);
                        connectionTimeInterval = null;
                    }
                    ws = null;
                };

                ws.onerror = function(error) {
                    log(`WebSocket错误: ${error}`, 'error');
                    updateStatus('连接错误', 'status-disconnected');
                    updateButtons(false);
                };

            } catch (error) {
                log(`连接失败: ${error.message}`, 'error');
                updateStatus('连接失败', 'status-disconnected');
                updateButtons(false);
            }
        }

        // 断开WebSocket
        function disconnectWebSocket() {
            if (ws) {
                log('正在断开WebSocket连接...');
                ws.close();
            }
        }

        // 启动摄像头
        function startCamera() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                log('发送启动摄像头命令');
                ws.send(JSON.stringify({
                    action: 'start_camera',
                    camera_id: 'default'
                }));
            }
        }

        // 停止摄像头
        function stopCamera() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                log('发送停止摄像头命令');
                ws.send(JSON.stringify({
                    action: 'stop_camera',
                    camera_id: 'default'
                }));
            }
        }

        // 清空日志
        function clearLog() {
            logContent.textContent = '';
            frameCount = 0;
            frameCountElement.textContent = '0';
            fpsElement.textContent = '0';
            log('日志已清空');
        }

        // 事件监听器
        connectBtn.addEventListener('click', connectWebSocket);
        disconnectBtn.addEventListener('click', disconnectWebSocket);
        startCameraBtn.addEventListener('click', startCamera);
        stopCameraBtn.addEventListener('click', stopCamera);
        clearLogBtn.addEventListener('click', clearLog);

        // 页面加载完成后的初始化
        document.addEventListener('DOMContentLoaded', function() {
            log('WebSocket摄像头测试页面已加载');
            log('点击"连接WebSocket"开始测试');
        });

        // 页面卸载时清理
        window.addEventListener('beforeunload', function() {
            if (ws) {
                ws.close();
            }
        });
    </script>
</body>
</html>
