# 摄像头服务器 C++ 版本开发日志

## 项目概述

**项目名称**：RK3588 摄像头服务器与 Web 客户端 (C++ 版本)
**开发开始日期**：2025-05-14
**开发平台**：RK3588 开发板（香橙派 5 Plus）
**CPU 架构**：ARM64 (AArch64)
**操作系统**：Armbian（基于 Debian/Ubuntu 的 RK3588 优化版本）

### 项目背景

本项目是原 Rust 版本摄像头服务器的 C++ 重新实现。项目旨在利用瑞芯微 RK3588 开发板的硬件能力，构建一个功能强大的摄像头服务器。该服务器能够连接摄像头，实现视频流的采集、编码和录制，并支持将已录制的视频文件拆解为一系列静态图像帧。项目同时包含一个基于 Web 浏览器的客户端界面，用户可以通过任何设备的浏览器远程访问、控制服务器的功能并获取其状态信息。

### 核心目标

- 提供稳定、高效的远程摄像头解决方案
- 支持高质量视频录制和后续的图像帧提取
- 通过通用的 Web 浏览器提供便捷的访问和控制方式
- 充分利用 RK3588 的硬件加速能力

### 主要功能

1. **视频采集**：
   - 摄像头开启和关闭控制
   - 从连接的摄像头获取视频流
   - 支持配置采集参数（分辨率、帧率等）

2. **视频录制**：
   - 将视频流编码并保存为视频文件
   - 视频文件管理（列表、删除、重命名等）
   - 支持按需启动和停止录制

3. **视频拆分**：
   - 将视频文件拆分为静态图像帧
   - 静态帧文件和文件夹管理
   - 支持指定拆分参数（如帧率、格式）

4. **服务器API**：
   - 提供RESTful API接口
   - 支持远程控制采集、录制、拆分等功能
   - 获取服务器状态和文件列表

5. **Web客户端**：
   - 基于浏览器的用户界面
   - 远程控制和状态显示
   - 显示录制文件列表和拆分任务进度

## 技术栈选择

### 主要技术栈

- **编程语言**：C++17/20
- **构建系统**：CMake
- **视频处理**：FFmpeg/libav
- **摄像头接口**：V4L2
- **Web服务器**：Crow 或 Drogon
- **前端框架**：Vue.js 或 React

### 为什么选择 C++？

1. **性能与控制**：C++ 提供接近硬件的性能和对系统资源的精细控制，这对处理视频流这类资源密集型任务非常重要。

2. **硬件加速集成**：C++ 可以更容易地与 RK3588 的硬件加速 API 集成，如 MPP (Media Process Platform)。

3. **生态系统**：C++ 在视频处理和嵌入式系统领域有丰富的库和工具支持。

4. **开发团队熟悉度**：开发团队对 C++ 更为熟悉，可以提高开发效率。

## 项目架构

### 模块划分

1. **摄像头模块** (CameraModule)
   - 摄像头设备检测和初始化
   - 视频流采集
   - 采集参数配置（分辨率、帧率等）

2. **视频处理模块** (VideoModule)
   - 视频编码和录制
   - 视频文件管理
   - 视频拆分为图像帧

3. **API服务模块** (ApiModule)
   - RESTful API 接口
   - Web 服务器（提供静态文件）
   - 文件下载服务

4. **存储管理模块** (StorageModule)
   - 文件系统操作
   - 文件命名和组织
   - 存储空间管理
   - 文件打包功能

5. **系统监控模块** (MonitorModule)
   - 系统资源监控（CPU、内存、存储）
   - 服务状态监控
   - 日志记录和管理

6. **主应用** (MainApplication)
   - 集成所有模块
   - 配置管理
   - 命令行界面

### 项目结构

```
cam_server_cpp/
├── CMakeLists.txt                # 主CMake配置文件
├── cmake/                        # CMake模块和配置
├── docs/                         # 文档
├── include/                      # 头文件
│   ├── camera/                   # 摄像头模块头文件
│   ├── video/                    # 视频处理模块头文件
│   ├── api/                      # API服务模块头文件
│   ├── storage/                  # 存储管理模块头文件
│   ├── monitor/                  # 系统监控模块头文件
│   └── utils/                    # 工具类和通用功能
├── libs/                         # 第三方库
├── referenceDoc/                 # 参考文档（原Rust项目）
├── scripts/                      # 构建和部署脚本
├── src/                          # 源文件
│   ├── camera/                   # 摄像头模块实现
│   ├── video/                    # 视频处理模块实现
│   ├── api/                      # API服务模块实现
│   ├── storage/                  # 存储管理模块实现
│   ├── monitor/                  # 系统监控模块实现
│   ├── utils/                    # 工具类和通用功能实现
│   └── main.cpp                  # 主程序入口
├── tests/                        # 测试
│   ├── camera_tests/             # 摄像头模块测试
│   ├── video_tests/              # 视频处理模块测试
│   ├── api_tests/                # API服务模块测试
│   ├── storage_tests/            # 存储管理模块测试
│   └── monitor_tests/            # 系统监控模块测试
└── web_client/                   # Web客户端
    ├── public/                   # 静态资源
    ├── src/                      # 前端源代码
    └── package.json              # 前端依赖配置
```

## 开发计划

### 第一阶段：基础框架搭建（预计时间：1周）

- [ ] 创建项目结构和CMake配置
- [ ] 实现基本的配置加载和日志系统
- [ ] 搭建简单的命令行界面
- [ ] 设计并实现核心数据结构

### 第二阶段：摄像头模块（预计时间：2周）

- [ ] 实现摄像头设备检测和初始化
- [ ] 实现视频流采集功能
- [ ] 添加采集参数配置（分辨率、帧率等）
- [ ] 实现摄像头开启和关闭控制
- [ ] 测试不同摄像头设备的兼容性

### 第三阶段：视频处理模块（预计时间：2周）

- [ ] 实现视频编码和录制功能
- [ ] 实现视频文件管理（列表、删除、重命名）
- [ ] 实现视频拆分为图像帧的功能
- [ ] 实现静态帧文件和文件夹管理
- [ ] 优化硬件加速使用

### 第四阶段：API和Web客户端（预计时间：2周）

- [ ] 实现RESTful API接口
- [ ] 实现文件下载服务
- [ ] 实现系统监控功能
- [ ] 开发基本的Web客户端界面
- [ ] 集成所有模块，确保协同工作

### 第五阶段：优化和测试（预计时间：1周）

- [ ] 性能优化，特别是视频处理部分
- [ ] 全面测试各个功能
- [ ] 编写详细文档
- [ ] 完善Web客户端界面
- [ ] 优化用户体验

## 开发日志

### 2025-05-14 - 项目初始化

**完成工作**：
- 创建项目仓库
- 设计项目架构
- 确定技术栈
- 创建开发日志文档

**下一步计划**：
- 创建基础项目结构
- 实现基本的配置加载和日志系统

### 2025-05-15 - 基础项目结构搭建

**完成工作**：
- 创建项目目录结构
- 创建CMakeLists.txt文件
- 创建各模块的头文件
- 创建README.md文件
- 更新开发日志

**遇到的问题**：
- 无

**下一步计划**：
- 实现摄像头模块的基本功能
- 实现配置管理器和日志系统
- 创建简单的命令行界面

### 2025-05-16 - 摄像头模块和配置管理器实现

**完成工作**：
- 实现摄像头模块的基本功能
  - 摄像头设备检测和初始化
  - 视频流采集功能
  - 采集参数配置
- 实现配置管理器
  - 配置文件加载和保存
  - 配置项获取和设置
- 实现日志系统
  - 日志级别控制
  - 文件和控制台输出
  - 异步日志功能

**遇到的问题**：
- V4L2摄像头设备初始化时需要处理不同摄像头的兼容性问题
- 配置文件格式需要统一，选择了JSON格式

**下一步计划**：
- 实现视频处理模块
- 实现视频录制功能
- 实现视频拆分功能

### 2025-05-17 - 视频处理模块实现

**完成工作**：
- 实现视频录制功能
  - 基于FFmpeg的视频编码和录制
  - 支持硬件加速编码
  - 录制参数配置
- 实现视频拆分功能
  - 将视频文件拆分为图像帧
  - 支持不同的拆分参数
  - 支持生成缩略图
- 实现存储管理模块
  - 文件系统操作
  - 文件命名和组织
  - 存储空间管理
- 实现系统监控模块
  - 系统资源监控
  - 服务状态监控
  - 日志记录和管理

**遇到的问题**：
- FFmpeg硬件加速配置需要针对RK3588进行优化
- 视频拆分过程中需要处理大文件，需要优化内存使用

**下一步计划**：
- 实现API服务模块
- 开发Web客户端界面
- 集成所有模块，确保协同工作
