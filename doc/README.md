# LuBan 边缘处理器 (C++版本)

基于RK3588开发板的边缘处理器与Web客户端，支持摄像头视频采集、录制和拆分为静态图像帧。

## 项目概述

本项目旨在利用瑞芯微RK3588开发板的硬件能力，构建一个功能强大的边缘处理器。该处理器能够连接摄像头，实现视频流的采集、编码和录制，并支持将已录制的视频文件拆解为一系列静态图像帧。项目同时包含一个基于Web浏览器的客户端界面，用户可以通过任何设备的浏览器远程访问、控制处理器的功能并获取其状态信息。

### 任务进度(2025-05-20)

- **编译问题修复**：修复了v4l2_camera.cpp中的environ变量引用问题，改用getenv()函数
- **摄像头功能完善**：成功实现摄像头设备的打开/关闭和预览功能
- **MJPEG流媒体服务**：支持多个客户端连接，实现帧回调处理
- **稳定性改进**：添加更多错误检查和资源释放逻辑，提高系统稳定性
- **调试信息增强**：添加详细的调试日志输出，便于问题排查
- **已知问题**：系统在启动后立即开始捕获视频帧，而不是等待用户通过Web界面配置并启动，导致不必要的资源消耗和潜在的段错误

### 程序流程与架构

#### 主要流程

1. **初始化阶段**：
   - 设置本地化环境（解决中文乱码问题）
   - 设置信号处理器（捕获SIGINT, SIGTERM等）
   - 记录系统信息到日志文件
   - 初始化日志系统（Logger类）
   - 初始化配置管理器（加载config.json）
   - 初始化存储管理器（管理视频和图像文件）
   - 初始化摄像头管理器（但不立即开启摄像头）
   - 初始化API服务器（Mongoose HTTP服务器）
   - 初始化系统监控器（监控CPU、内存等）

2. **运行阶段**：
   - 主循环中执行周期性任务（自动清理存储、系统状态更新）
   - API服务器处理来自Web客户端的请求
   - 用户通过Web界面配置和控制摄像头操作
   - 摄像头捕获视频帧，提供给MJPEG流和视频录制模块

3. **关闭阶段**：
   - 接收关闭信号（如Ctrl+C）
   - 停止系统监控器
   - 停止API服务器
   - 关闭摄像头设备
   - 记录关闭信息并退出

#### 线程架构

系统运行时创建以下线程：

1. **主线程**：
   - 初始化各个模块
   - 执行主循环
   - 处理信号并协调关闭过程

2. **API服务器线程**：
   - 由ApiServer::start()创建
   - 处理HTTP请求
   - 提供REST API和静态文件服务

3. **摄像头捕获线程**：
   - 由V4L2Camera::startCapture()创建
   - 从摄像头设备读取视频帧
   - 处理帧数据并通知观察者

4. **MJPEG流线程**：
   - 为每个连接到/api/stream的客户端创建
   - 将摄像头帧编码为JPEG并发送
   - 维护客户端连接状态

5. **系统监控线程**：
   - 由SystemMonitor::start()创建
   - 定期收集系统状态信息
   - 更新系统监控数据供API使用

#### 连接数与限制

- **最大HTTP连接数**：默认为100个并发连接，由Mongoose配置决定
- **MJPEG流并发客户端**：理论上支持与HTTP连接数相同的并发流，但实际受限于网络带宽和处理能力
- **活跃连接超时**：HTTP连接默认超时时间为30秒，MJPEG流连接保持活跃状态直到客户端断开

#### API路由

系统支持以下主要API端点：

1. **静态资源**：
   - `/` 或 `/index.html` - Web界面主页
   - `/css/*` - 样式表文件
   - `/js/*` - JavaScript文件
   - `/images/*` - 图像资源

2. **摄像头控制**：
   - `/api/cameras` - GET：获取可用摄像头列表
   - `/api/cameras/:id` - GET：获取特定摄像头信息
   - `/api/cameras/:id/open` - POST：打开摄像头
   - `/api/cameras/:id/close` - POST：关闭摄像头
   - `/api/cameras/:id/start` - POST：开始捕获
   - `/api/cameras/:id/stop` - POST：停止捕获
   - `/api/cameras/:id/params` - GET/POST：获取/设置摄像头参数

3. **流媒体**：
   - `/api/stream` - GET：MJPEG视频流
   - `/api/snapshot` - GET：获取当前帧的JPEG图像

4. **录制控制**：
   - `/api/recording/start` - POST：开始录制
   - `/api/recording/stop` - POST：停止录制
   - `/api/recordings` - GET：获取录制列表
   - `/api/recordings/:id` - GET/DELETE：获取/删除特定录制

5. **系统信息**：
   - `/api/system/info` - GET：获取系统状态信息
   - `/api/system/stats` - GET：获取实时性能统计

### 当前问题分析(2025-05-20)

通过日志分析发现，系统启动后摄像头立即开始捕获视频帧：
```
[V4L2][v4l2_camera.cpp:processFrame] 处理新帧:
  - 缓冲区大小: 71708 字节
  - 当前格式: 2
  - 分辨率: 1024x768
  - 时间戳: 606994.878969
[V4L2][v4l2_camera.cpp:processFrame] 帧对象创建完成:
  - 帧大小: 71708 字节
  - 帧格式: 2
  - 帧分辨率: 1024x768
[V4L2][v4l2_camera.cpp:processFrame] 调用帧回调函数
[V4L2][v4l2_camera.cpp:processFrame] 帧已添加到队列
```

这种行为不符合预期。正确的流程应该是：
1. 系统启动并初始化摄像头管理器，但不开启摄像头
2. 用户通过Web界面选择摄像头、分辨率和帧率
3. 用户点击"重置摄像头"并应用设置后，才开始摄像头捕获操作

当前的错误行为导致以下问题：
- 资源浪费：在无人使用时也占用系统资源
- 稳定性问题：可能导致"heap-use-after-free"等内存错误
- 用户体验差：用户无法完全控制摄像头行为

### 修复计划

修改摄像头初始化流程，使其按照以下步骤工作：
1. 初始化摄像头管理器但不自动开启摄像头
2. 只有在用户通过Web界面明确请求时才启动捕获操作
3. 增强状态管理，确保摄像头资源正确管理

## 主要功能

- **视频采集**：摄像头开启和关闭控制，从连接的摄像头获取视频流
- **视频录制**：将视频流编码并保存为视频文件，视频文件管理
- **视频拆分**：将视频文件拆分为静态图像帧，静态帧文件夹管理和打包
- **实时预览**：通过Web浏览器实时查看摄像头视频流
- **远程控制**：通过Web界面远程控制和管理上述功能，摄像头参数控制
- **系统监控**：监控和显示系统状态信息（CPU、内存、存储、网络）

## 技术栈

- **编程语言**：C++17/20
- **构建系统**：CMake
- **视频处理**：FFmpeg/libav
- **摄像头接口**：V4L2
- **Web服务器**：Mongoose（嵌入式HTTP/WebSocket服务器）
- **前端技术**：HTML5, CSS3, JavaScript（原生）
- **实时流**：MJPEG流通过HTTP

## 项目结构

```
cam_server_cpp/
├── CMakeLists.txt                # 主CMake配置文件
├── doc/                          # 项目文档
│   ├── README.md                 # 主文档
│   ├── api.md                    # API文档
│   └── ...                       # 其他文档
├── logs/                         # 系统日志
│   ├── server.log                # 服务日志
│   └── dev_*.log                 # 开发日志
├── static/                       # 静态资源
│   ├── css/                      # 样式文件
│   ├── js/                       # 脚本文件
│   └── ...
├── src/                          # 源代码
│   ├── camera/                   # 摄像头模块
│   ├── video/                    # 视频处理模块
│   └── ...
├── third_party/                  # 第三方库
│   └── mongoose/                 # Mongoose嵌入式Web服务器
├── config/                       # 配置文件
├── scripts/                      # 构建和部署脚本
└── build/                        # 构建输出目录（可选）
```

注：
1. 所有文档统一存放在 `doc/` 目录
2. 所有日志统一输出到 `logs/` 目录
3. 可执行文件默认生成在项目根目录

## 环境要求

- **操作系统**：Armbian（基于Debian/Ubuntu的RK3588优化版本）
- **开发板**：RK3588（如香橙派5 Plus）
- **依赖库**：
  - FFmpeg开发库（libavcodec-dev, libavformat-dev, libavutil-dev, libswscale-dev）
  - V4L2开发库（libv4l-dev）
  - 可选：RK3588 MPP（Media Process Platform）
  - 可选：LibRGA（Rockchip Graphics Acceleration）

## RK3588硬件信息

### 温度传感器

RK3588开发板上有多个温度传感器，可以通过`/sys/class/thermal/`目录访问：

- **thermal_zone0**: soc-thermal (整体SoC温度)
- **thermal_zone1**: bigcore0-thermal (大核心0温度)
- **thermal_zone2**: bigcore1-thermal (大核心1温度)
- **thermal_zone3**: littlecore-thermal (小核心温度)
- **thermal_zone4**: center-thermal (中心温度)
- **thermal_zone5**: gpu-thermal (GPU温度)
- **thermal_zone6**: npu-thermal (NPU温度)

获取温度示例：
```bash
# 获取GPU温度（毫摄氏度，需要除以1000转换为摄氏度）
cat /sys/class/thermal/thermal_zone5/temp
# 输出示例：38846（表示38.846°C）
```

### 处理器架构

RK3588采用了ARM的大小核架构（big.LITTLE架构），这是一种异构多核处理器架构，结合了高性能核心和高能效核心，以平衡性能和功耗。

**处理器配置**：
- **大核心**：4个Cortex-A76核心，主频最高2.4GHz，分为两个集群
- **小核心**：4个Cortex-A55核心，主频约1.8GHz，组成一个集群
- **总计**：8个CPU核心，采用DynamIQ架构

**工作原理**：
- 轻量级任务（如后台服务）分配给小核心，节省电力
- 计算密集型任务（如视频编码）分配给大核心，提供高性能
- 系统可以根据负载动态调整使用的核心和频率

**监控意义**：
- 监控不同核心集群的温度和使用率，可以帮助识别性能瓶颈
- 优化应用程序以更好地利用大小核架构，提高性能和降低功耗

## 构建说明

### 安装依赖

```bash
# 安装基本开发工具
sudo apt-get update
sudo apt-get install -y \
    build-essential \
    cmake \
    pkg-config \
    git

# 安装FFmpeg开发库
sudo apt-get install -y \
    libavcodec-dev \
    libavformat-dev \
    libavutil-dev \
    libswscale-dev

# 安装V4L2开发库
sudo apt-get install -y \
    libv4l-dev \
    v4l-utils

# 安装RK3588特定的开发库（可选）
sudo apt-get install -y \
    librga-dev \
    rockchip-mpp-dev

# 安装 fmt 库
sudo apt-get install -y libfmt-dev
```

### 构建项目

```bash
# 克隆仓库
git clone <repository-url>
cd cam_server_cpp

# 使用构建脚本
./scripts/build.sh

# 或者手动构建
mkdir -p build
cd build
cmake ..
make -j$(nproc)
```

### 构建选项

构建脚本支持以下选项：

- `--release`：构建发布版本（默认为调试版本）
- `--debug`：构建调试版本
- `--no-tests`：不构建测试
- `--with-opencv`：使用OpenCV（可选）
- `--no-hardware-accel`：不使用硬件加速
- `--clean`：清理构建目录
- `--help`：显示帮助信息

## 使用说明

### 启动服务器

```bash
# 使用默认配置
./build/bin/cam_server

# 指定配置文件
./build/bin/cam_server --config config.json
```

### 访问Web界面

启动服务器后，可以通过浏览器访问Web界面：

```
http://<rk3588-ip-address>:8080
```

Web界面包含以下页面：

- **首页（/index.html）**：集成了实时预览和系统信息功能，包含两个可切换的标签页：
  - **摄像头预览**：显示摄像头视频流，提供预览、拍照和录制功能，支持选择摄像头、分辨率和帧率
  - **系统信息**：显示系统状态信息，包括CPU温度、GPU温度、内存使用率、磁盘使用情况、IP地址和WiFi SSID等

### 实时预览功能

系统支持通过Web浏览器实时预览摄像头视频流：

```
http://<rk3588-ip-address>:8080/api/stream
```

也可以通过主页面访问实时预览功能，支持以下参数：

- **width**: 视频宽度（像素）
- **height**: 视频高度（像素）
- **quality**: JPEG质量（1-100）
- **fps**: 最大帧率

示例：
```
http://<rk3588-ip-address>:8080/api/stream?width=1280&height=720&quality=80&fps=30
```

### 拍照和录制功能

Web界面支持以下功能：

- **拍照**：在摄像头选择页面，可以拍摄当前帧并保存为JPEG图像
- **录制**：在摄像头选择页面，可以开始和停止视频录制，支持MP4格式
- **预览**：在所有页面，可以实时预览摄像头视频流
- **设备控制**：在设备管理页面，可以控制摄像头设备的参数

### 开发日志和环境配置

在开发过程中，请及时更新以下文档：

- **查看开发日志**：`cat dev_log.md` 或使用文本编辑器打开
- **更新开发日志**：在 `dev_log.md` 中添加新的开发记录，包括完成的工作、遇到的问题和解决方案
- **查看环境配置**：`cat dev_env.md` 或使用文本编辑器打开
- **更新环境配置**：当开发环境有变化时，在 `dev_env.md` 中更新相关配置信息

这些文档对于项目的长期维护和新开发人员的加入非常重要，请确保它们始终保持最新状态。

### 当前开发进度

#### 已完成模块
- **摄像头模块**：实现了CameraDevice接口和V4L2Camera类，支持摄像头设备的基本操作
- **视频录制模块**：实现了IVideoRecorder接口和FFmpegRecorder类，支持视频流的编码和录制
- **视频分割模块**：实现了IVideoSplitter接口和FFmpegSplitter类，支持将视频文件拆分为静态图像帧
- **日志系统**：实现了Logger类，支持多级别日志、文件和控制台输出、异步日志等功能
- **文件工具类**：实现了FileUtils类，提供文件和目录操作的通用功能
- **字符串工具类**：实现了StringUtils类，提供字符串处理的通用功能
- **配置管理器**：实现了ConfigManager类，支持配置的加载、保存和访问
- **REST API处理器**：实现了RestHandler类，支持HTTP请求的路由和处理
- **Web服务器模块**：实现了基于Mongoose的Web服务器，支持静态文件服务和API路由
- **MJPEG流媒体服务**：实现了基于HTTP的MJPEG流媒体服务，支持实时视频预览和多客户端连接
- **API接口实现**：实现了系统信息和摄像头控制的API接口
- **Web客户端**：实现了完整的Web界面，包括实时预览、设备管理、摄像头选择和系统信息页面
- **拍照功能**：实现了拍照和图像保存功能，支持在Web界面上拍摄当前帧并保存为JPEG图像
- **摄像头连接管理**：实现了摄像头连接的完整生命周期管理，包括打开、预览、停止和关闭
- **系统信息显示**：实现了系统信息页面，显示CPU温度、GPU温度、内存使用率、磁盘使用情况、IP地址和WiFi SSID等
- **用户界面优化**：优化了按钮布局和样式，提高了用户体验
- **环境变量处理**：改进环境变量获取方式，增强系统兼容性

#### 进行中模块
- **视频录制功能**：正在实现视频录制和回放功能，支持MP4格式的视频录制和播放
- **存储管理模块**：正在实现视频文件和图像文件的存储管理，包括文件列表、删除和下载功能
- **MJPEG流优化**：正在优化MJPEG流处理，解决偶发的段错误问题
- **错误处理改进**：正在添加更详细的错误信息和用户友好的错误提示
- **权限管理**：正在实现更完善的权限控制系统，确保设备访问安全

#### 待实现模块
- **视频拆分功能**：将视频文件拆分为图像帧，支持不同的图像格式和拆分参数
- **高级摄像头控制**：支持更多摄像头参数调整，如亮度、对比度、饱和度等
- **图像处理功能**：添加基本的图像处理功能，如滤镜、特效等
- **高级录制功能**：实现更高级的录制功能，如定时录制、分段录制等
- **用户认证**：实现基本的用户认证和权限控制，保护敏感操作和数据
- **性能优化**：优化视频处理和流媒体服务的性能，提高系统稳定性和响应速度
- **多摄像头支持**：支持同时连接和控制多个摄像头设备
- **视频分析功能**：添加基本的视频分析功能，如运动检测、对象识别等

## 项目文档

### 核心文档

- **README.md**: 项目概述、功能介绍、构建和使用说明，是项目的主要入口文档
- **dev_log.md**: 开发日志，记录项目开发过程中的进展、问题和解决方案，按时间顺序组织，便于追踪项目历史
- **dev_env.md**: 开发环境配置文档，详细记录硬件环境、软件环境、依赖库和工具配置，帮助新开发者快速搭建开发环境
- **dev_board_log.md**: 开发板环境日志，记录RK3588开发板的硬件配置、系统信息和性能测试结果，为性能优化提供基准数据

### 技术文档

- **docs/api.md**: API文档，包含所有可用的API端点、参数说明和使用示例，是Web客户端和服务器交互的接口规范
- **docs/development.md**: 开发指南，包含项目架构、模块设计、代码规范和开发流程等信息，是开发者必读的指导文档
- **docs/camera.md**: 摄像头模块文档，包含摄像头接口、参数配置和使用示例，详细说明如何与不同类型的摄像头设备交互
- **docs/video.md**: 视频处理模块文档，包含视频录制和拆分功能说明，以及如何利用RK3588硬件加速能力
- **docs/storage.md**: 存储管理模块文档，包含文件管理、存储策略和数据备份方案说明
- **docs/streaming.md**: 视频流模块文档，包含MJPEG流实现、WebSocket通信和实时预览功能说明
- **docs/system.md**: 系统信息模块文档，包含系统监控、资源使用统计和性能优化建议

### 参考文档

- **referenceDoc/**: 原Rust项目的参考文档，包含项目需求和设计思路，是本C++项目的功能参考和设计依据
  - **referenceDoc/requirements.md**: 原项目的需求文档，详细说明了项目的功能需求和非功能需求
  - **referenceDoc/design.md**: 原项目的设计文档，包含架构设计和模块划分
  - **referenceDoc/api_spec.md**: 原项目的API规范，定义了服务器和客户端之间的通信接口

### 用户文档

- **docs/user_manual.md**: 用户手册，面向最终用户，详细说明如何安装、配置和使用本系统
- **docs/troubleshooting.md**: 故障排除指南，包含常见问题和解决方案
- **docs/faq.md**: 常见问题解答，收集用户经常提出的问题及其答案

### 如何使用这些文档

1. **新开发者入门**：
   - 首先阅读README.md了解项目概况
   - 然后查看dev_env.md配置开发环境
   - 查看dev_board_log.md了解开发板硬件和性能特性
   - 接着阅读docs/development.md了解开发流程
   - 最后查看dev_log.md了解项目当前状态

2. **功能开发参考**：
   - 查看相应模块的技术文档（如docs/camera.md）
   - 参考referenceDoc/中的原始需求和设计
   - 在dev_log.md中记录开发进展

3. **问题排查**：
   - 查看docs/troubleshooting.md寻找常见问题的解决方案
   - 在dev_log.md中记录遇到的问题和解决方法

4. **环境配置更新**：
   - 当开发环境有变化时，更新dev_env.md
   - 确保新增的依赖库和工具都有详细的安装说明

5. **性能优化**：
   - 参考dev_board_log.md中的性能测试结果作为基准
   - 在优化后重新运行性能测试，并更新测试结果
   - 记录性能改进和优化方法

## 许可证

[待定]

## 贡献指南

### 代码贡献流程
1. Fork项目仓库
2. 创建功能分支 (`git checkout -b feature/amazing-feature`)
3. 提交更改 (`git commit -m 'Add some amazing feature'`)
4. 推送到分支 (`git push origin feature/amazing-feature`)
5. 创建Pull Request

### 开发规范
- 遵循C++17/20标准
- 使用4空格缩进
- 类名使用PascalCase命名法
- 方法和变量使用snake_case命名法
- 常量使用UPPER_CASE命名法
- 所有代码必须包含适当的注释
- 所有公共API必须有文档注释
- 提交前运行单元测试确保代码质量

### 文档贡献
- 更新技术文档以反映代码变更
- 改进用户文档使其更加清晰易懂
- 添加示例和教程帮助用户理解系统

### 问题报告
- 使用GitHub Issues报告bug
- 包含详细的复现步骤
- 如果可能，提供日志和截图
- 标记相关的标签以便分类

## 可执行文件输出目录说明

项目中的可执行文件（如 `cam_server`）默认生成在**项目根目录**下，而非标准的 `build/bin` 目录。这是有意为之的设计，原因如下：

1. **资源访问需求**  
   后端程序 `cam_server` 需要直接访问同级目录下的 `static/` 文件夹中的资源（如网页、配置文件等）。若可执行文件放在其他路径（如 `build/bin`），会导致资源路径解析复杂化。

2. **部署便捷性**  
   在开发和生产环境中，保持可执行文件与资源文件的相对路径一致，避免因路径差异导致的运行时错误。

### 重要提醒
- 请勿随意修改 `CMakeLists.txt` 中的以下配置：
  ```cmake
  set(CMAKE_RUNTIME_OUTPUT_DIRECTORY ${CMAKE_SOURCE_DIR})
  ```
  除非你明确理解修改后的影响，并已测试资源加载逻辑。
- 如需更精准控制，可改用 `set_target_properties()`，但需确保资源路径仍能正确解析。

## 重要目录说明

1. **项目文档**  
   所有文档（包括开发指南、API说明、用户手册等）均存放在 `doc/` 目录下。这是项目的唯一文档来源，请勿在其他位置存放文档。

2. **日志文件**  
   所有运行时日志和系统日志均输出到 `logs/` 目录。包括：
   - 服务日志（`server.log`）
   - 开发环境日志（`dev_*.log`）
   - 其他模块日志

   > 注意：请定期清理日志文件以避免占用过多磁盘空间。