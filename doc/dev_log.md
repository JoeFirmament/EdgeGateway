# 摄像头服务器开发日志

## 2025-05-20

### 问题分析
- 程序启动后摄像头立即开始捕获视频帧，而不是等待用户配置并手动启动
- 日志显示在没有用户通过Web界面操作的情况下就有大量帧处理日志
- 可能导致资源浪费和"heap-use-after-free"内存错误

### 解决方案
- 修改V4L2Camera::open方法，移除自动启动流和捕获线程的代码
- 将设备初始化与实际帧捕获分开处理
- 添加detectPixelFormat方法用于获取当前格式信息
- 确保只有在用户通过Web界面明确请求时才会启动摄像头捕获

### 验证结果
- 程序启动后不再自动捕获视频帧
- 摄像头资源只有在用户请求时才会被使用
- 系统稳定性明显提高，未再观察到之前的内存错误

## 2025-05-19

### 当前问题
- 出现Segmentation fault错误
- 发生在MJPEG流传输和HTTP请求同时处理时
- 已尝试的解决方案：
  - 添加深拷贝保护JPEG数据
  - 优化锁机制避免死锁
  - 增加详细日志定位问题

### 调试进展
1. 确认问题发生在客户端回调执行期间
2. 可能是多线程竞争或内存访问问题
3. 已添加核心转储分析工具

### 下一步计划
- 使用gdb分析核心转储
- 检查回调函数的内存管理
- 验证FFmpeg资源释放

## 2025-05-18
- 初始版本完成
- 基本功能测试通过
