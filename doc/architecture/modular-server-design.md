# ğŸ—ï¸ æ¨¡å—åŒ–æœåŠ¡å™¨æ¶æ„è®¾è®¡

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£æè¿°äº†æ‘„åƒå¤´è§†é¢‘æµæœåŠ¡å™¨çš„æ¨¡å—åŒ–é‡æ„è®¾è®¡ï¼Œå°†åŸæœ‰çš„å•ä½“æ–‡ä»¶ `websocket_video_stream_test.cpp` (2000+è¡Œ) é‡æ„ä¸ºå¤šä¸ªä¸“æ³¨çš„æ¨¡å—ï¼Œæ¯ä¸ªæ¨¡å—ä¸è¶…è¿‡500è¡Œä»£ç ã€‚

## ğŸ¯ è®¾è®¡ç›®æ ‡

### æ ¸å¿ƒåŸåˆ™
- **å•ä¸€èŒè´£åŸåˆ™** - æ¯ä¸ªæ¨¡å—åªè´Ÿè´£ä¸€ä¸ªç‰¹å®šåŠŸèƒ½
- **ä»£ç å¯ç»´æŠ¤æ€§** - æ¯ä¸ªæ–‡ä»¶æ§åˆ¶åœ¨500è¡Œä»¥å†…
- **åŠŸèƒ½å®Œæ•´æ€§** - ä¿æŒæ‰€æœ‰åŸæœ‰åŠŸèƒ½ä¸å˜
- **æ€§èƒ½ä¸€è‡´æ€§** - é‡æ„ä¸å½±å“ç³»ç»Ÿæ€§èƒ½
- **æ‰©å±•å‹å¥½æ€§** - ä¾¿äºæ·»åŠ æ–°åŠŸèƒ½

### è´¨é‡ç›®æ ‡
- âœ… ä»£ç è¡Œæ•°æ§åˆ¶ï¼šæ¯ä¸ªæ–‡ä»¶ â‰¤ 500è¡Œ
- âœ… åŠŸèƒ½å®Œæ•´æ€§ï¼š100%ä¿ç•™åŸæœ‰åŠŸèƒ½
- âœ… æ€§èƒ½ä¿æŒï¼šæ— æ€§èƒ½æŸå¤±
- âœ… å¯ç»´æŠ¤æ€§ï¼šæ¨¡å—è¾¹ç•Œæ¸…æ™°
- âœ… å¯æµ‹è¯•æ€§ï¼šæ”¯æŒå•å…ƒæµ‹è¯•

## ğŸ“ æ¨¡å—æ¶æ„

### ğŸ—‚ï¸ ç›®å½•ç»“æ„
```
cam_server_cpp/
â”œâ”€â”€ main_server.cpp                    # æ–°çš„ä¸»ç¨‹åºå…¥å£ (~100è¡Œ)
â”œâ”€â”€ websocket_video_stream_test.cpp    # åŸå§‹æ–‡ä»¶(ä¿ç•™ä½œä¸ºå‚è€ƒ)
â”œâ”€â”€ build_main_server.sh               # æ–°çš„ç¼–è¯‘è„šæœ¬
â”œâ”€â”€ build_websocket_video_stream_test.sh # åŸå§‹ç¼–è¯‘è„šæœ¬(ä¿ç•™)
â”œâ”€â”€ include/web/                       # Webæ¨¡å—å¤´æ–‡ä»¶
â”‚   â”œâ”€â”€ video_server.h                 # æœåŠ¡å™¨æ ¸å¿ƒç±»
â”‚   â”œâ”€â”€ http_routes.h                  # HTTPè·¯ç”±å¤„ç†
â”‚   â”œâ”€â”€ websocket_handler.h            # WebSocketå¤„ç†
â”‚   â”œâ”€â”€ frame_extraction_routes.h      # å¸§æå–è·¯ç”±
â”‚   â””â”€â”€ system_routes.h                # ç³»ç»Ÿä¿¡æ¯è·¯ç”±
â”œâ”€â”€ src/web/                           # Webæ¨¡å—å®ç°
â”‚   â”œâ”€â”€ video_server.cpp               # æœåŠ¡å™¨æ ¸å¿ƒå®ç° (~200è¡Œ)
â”‚   â”œâ”€â”€ http_routes.cpp                # HTTPè·¯ç”±å®ç° (~300è¡Œ)
â”‚   â”œâ”€â”€ websocket_handler.cpp          # WebSocketå®ç° (~300è¡Œ)
â”‚   â”œâ”€â”€ frame_extraction_routes.cpp    # å¸§æå–å®ç° (~200è¡Œ)
â”‚   â””â”€â”€ system_routes.cpp              # ç³»ç»Ÿä¿¡æ¯å®ç° (~150è¡Œ)
â””â”€â”€ doc/architecture/                  # æ¶æ„æ–‡æ¡£
    â””â”€â”€ modular-server-design.md       # æœ¬æ–‡æ¡£
```

## ğŸ§© æ¨¡å—è¯¦ç»†è®¾è®¡

### 1. ä¸»ç¨‹åºæ¨¡å— (`main_server.cpp`)
**èŒè´£**: ç¨‹åºå…¥å£ç‚¹å’Œç”Ÿå‘½å‘¨æœŸç®¡ç†
**ä»£ç è¡Œæ•°**: ~100è¡Œ

**åŠŸèƒ½**:
- å‘½ä»¤è¡Œå‚æ•°è§£æ (`-p/--port`, `-h/--help`)
- ä¿¡å·å¤„ç† (SIGINT, SIGTERM)
- æœåŠ¡å™¨å®ä¾‹åˆ›å»ºå’Œç®¡ç†
- é”™è¯¯å¤„ç†å’Œä¼˜é›…é€€å‡º

**æ¥å£**:
```cpp
int main(int argc, char* argv[]);
void signalHandler(int signal);
int parseArguments(int argc, char* argv[]);
void showUsage(const char* program_name);
```

### 2. æœåŠ¡å™¨æ ¸å¿ƒæ¨¡å— (`VideoServer`)
**èŒè´£**: æœåŠ¡å™¨æ ¸å¿ƒé€»è¾‘å’Œç»„ä»¶åè°ƒ
**ä»£ç è¡Œæ•°**: ~200è¡Œ

**åŠŸèƒ½**:
- ç»„ä»¶åˆå§‹åŒ– (æ‘„åƒå¤´ç®¡ç†å™¨ã€ç³»ç»Ÿç›‘æ§)
- è·¯ç”±è®¾ç½®åè°ƒ
- èµ„æºç®¡ç†å’Œæ¸…ç†
- é…ç½®ç®¡ç†

**æ ¸å¿ƒç±»**:
```cpp
class VideoServer {
public:
    bool initialize();
    bool start();
    void stop();
    void setPort(int port);

private:
    crow::SimpleApp app_;
    int port_;
    bool is_running_;
    // å®¢æˆ·ç«¯ç®¡ç†ã€ä»»åŠ¡ç®¡ç†ç­‰
};
```

### 3. HTTPè·¯ç”±æ¨¡å— (`HttpRoutes`)
**èŒè´£**: HTTP APIå’Œé™æ€æ–‡ä»¶æœåŠ¡
**ä»£ç è¡Œæ•°**: ~300è¡Œ

**åŠŸèƒ½**:
- é™æ€æ–‡ä»¶æœåŠ¡ (HTML, CSS, JS)
- å›¾ç‰‡API (`/api/photos/*`)
- è§†é¢‘API (`/api/videos/*`)
- é¡µé¢è·¯ç”± (`/*.html`)
- åŠ¨æ€HTMLè·¯ç”±å‘ç°

**æ¥å£**:
```cpp
class HttpRoutes {
public:
    static void setupStaticRoutes(crow::SimpleApp& app);
    static void setupPhotoRoutes(crow::SimpleApp& app);
    static void setupVideoRoutes(crow::SimpleApp& app);
    static void setupPageRoutes(crow::SimpleApp& app);
};
```

### 4. WebSocketå¤„ç†æ¨¡å— (`WebSocketHandler`)
**èŒè´£**: WebSocketè¿æ¥å’Œè§†é¢‘æµå¤„ç†
**ä»£ç è¡Œæ•°**: ~300è¡Œ

**åŠŸèƒ½**:
- WebSocketè¿æ¥ç®¡ç†
- å®¢æˆ·ç«¯çŠ¶æ€è·Ÿè¸ª
- è§†é¢‘æµä¼ è¾“
- æ¶ˆæ¯è·¯ç”±å’Œå¤„ç†
- é”™è¯¯å¤„ç†å’Œé‡è¿

**æ¥å£**:
```cpp
class WebSocketHandler {
public:
    static void setupRoutes(crow::SimpleApp& app, VideoServer* server);

private:
    static void onOpen(crow::websocket::connection& conn, VideoServer* server);
    static void onMessage(crow::websocket::connection& conn, const std::string& data,
                         bool is_binary, VideoServer* server);
    static void onClose(crow::websocket::connection& conn, const std::string& reason,
                       VideoServer* server);
};
```

### 5. å¸§æå–è·¯ç”±æ¨¡å— (`FrameExtractionRoutes`)
**èŒè´£**: è§†é¢‘å¸§æå–åŠŸèƒ½
**ä»£ç è¡Œæ•°**: ~200è¡Œ

**åŠŸèƒ½**:
- å¸§æå–ä»»åŠ¡ç®¡ç†
- MJPEGæ–‡ä»¶å¤„ç†
- è¿›åº¦è·Ÿè¸ª
- ç»“æœæ‰“åŒ…å’Œä¸‹è½½
- é¢„è§ˆå›¾ç‰‡ç”Ÿæˆ

**APIç«¯ç‚¹**:
- `POST /api/frame-extraction/start` - å¼€å§‹æå–
- `GET /api/frame-extraction/status/<task_id>` - è·å–çŠ¶æ€
- `POST /api/frame-extraction/stop/<task_id>` - åœæ­¢ä»»åŠ¡
- `GET /api/frame-extraction/download/<task_id>` - ä¸‹è½½ç»“æœ
- `GET /api/frame-extraction/preview/<task_id>/<filename>` - é¢„è§ˆå›¾ç‰‡

### 6. ç³»ç»Ÿä¿¡æ¯è·¯ç”±æ¨¡å— (`SystemRoutes`)
**èŒè´£**: ç³»ç»ŸçŠ¶æ€å’Œç¡¬ä»¶ä¿¡æ¯API
**ä»£ç è¡Œæ•°**: ~150è¡Œ

**åŠŸèƒ½**:
- ç³»ç»Ÿä¿¡æ¯è·å– (CPUã€å†…å­˜ã€å­˜å‚¨)
- ç¡¬ä»¶çŠ¶æ€ç›‘æ§
- æ‘„åƒå¤´è®¾å¤‡ä¿¡æ¯
- ç½‘ç»œæ¥å£ä¿¡æ¯
- å®æ—¶æ€§èƒ½æ•°æ®

**APIç«¯ç‚¹**:
- `GET /api/system/info` - ç³»ç»Ÿä¿¡æ¯
- `GET /api/system/cameras` - æ‘„åƒå¤´è®¾å¤‡

## ğŸ”„ æ•°æ®æµè®¾è®¡

### è¯·æ±‚å¤„ç†æµç¨‹
```
å®¢æˆ·ç«¯è¯·æ±‚ â†’ Crowè·¯ç”± â†’ å¯¹åº”æ¨¡å—å¤„ç† â†’ å“åº”è¿”å›

HTTPè¯·æ±‚:
Client â†’ HttpRoutes â†’ é™æ€æ–‡ä»¶/APIå¤„ç† â†’ Response

WebSocket:
Client â†’ WebSocketHandler â†’ VideoServer â†’ CameraManager â†’ è§†é¢‘æµ

å¸§æå–:
Client â†’ FrameExtractionRoutes â†’ å¼‚æ­¥ä»»åŠ¡ â†’ æ–‡ä»¶å¤„ç† â†’ ç»“æœè¿”å›

ç³»ç»Ÿä¿¡æ¯:
Client â†’ SystemRoutes â†’ SystemMonitor â†’ å®æ—¶æ•°æ® â†’ JSONå“åº”
```

### ç»„ä»¶ä¾èµ–å…³ç³»
```
main_server.cpp
    â†“
VideoServer (æ ¸å¿ƒåè°ƒ)
    â”œâ”€â”€ HttpRoutes (HTTPå¤„ç†)
    â”œâ”€â”€ WebSocketHandler (WebSocketå¤„ç†)
    â”œâ”€â”€ FrameExtractionRoutes (å¸§æå–)
    â”œâ”€â”€ SystemRoutes (ç³»ç»Ÿä¿¡æ¯)
    â”œâ”€â”€ CameraManager (æ‘„åƒå¤´ç®¡ç†)
    â””â”€â”€ SystemMonitor (ç³»ç»Ÿç›‘æ§)
```

## ğŸš€ å®æ–½è®¡åˆ’

### é˜¶æ®µ1: åŸºç¡€æ¶æ„ (å·²å®Œæˆ)
- âœ… åˆ›å»ºç›®å½•ç»“æ„
- âœ… å®šä¹‰å¤´æ–‡ä»¶æ¥å£
- âœ… åˆ›å»ºä¸»ç¨‹åºæ¡†æ¶
- âœ… è®¾è®¡ç¼–è¯‘è„šæœ¬
- âœ… åˆ›å»ºæ¶æ„æ–‡æ¡£

### é˜¶æ®µ2: æ ¸å¿ƒæ¨¡å—å®ç° (å·²å®Œæˆ)
- âœ… å®ç° VideoServer æ ¸å¿ƒç±» (~200è¡Œ)
- âœ… å®ç° HttpRoutes æ¨¡å— (~300è¡Œ)
- âœ… å®ç° WebSocketHandler æ¨¡å— (~300è¡Œ)

### é˜¶æ®µ3: åŠŸèƒ½æ¨¡å—å®ç° (å·²å®Œæˆ)
- âœ… å®ç° FrameExtractionRoutes æ¨¡å— (~200è¡Œ)
- âœ… å®ç° SystemRoutes æ¨¡å— (~150è¡Œ)
- âœ… åˆ›å»º Makefile ç¼–è¯‘ç³»ç»Ÿ
- âœ… æ›´æ–°ç³»ç»Ÿä¿¡æ¯é¡µé¢APIé›†æˆ

### é˜¶æ®µ4: éªŒè¯å’Œä¼˜åŒ–
- â³ åŠŸèƒ½å®Œæ•´æ€§æµ‹è¯•
- â³ æ€§èƒ½å¯¹æ¯”æµ‹è¯•
- â³ ä»£ç è´¨é‡æ£€æŸ¥
- â³ æ–‡æ¡£å®Œå–„

## ğŸ“Š è´¨é‡ä¿è¯

### ä»£ç è´¨é‡æŒ‡æ ‡
- **è¡Œæ•°æ§åˆ¶**: æ¯ä¸ªæ–‡ä»¶ â‰¤ 500è¡Œ
- **åœˆå¤æ‚åº¦**: æ¯ä¸ªå‡½æ•° â‰¤ 10
- **æ³¨é‡Šè¦†ç›–ç‡**: â‰¥ 20%
- **ç¼–è¯‘è­¦å‘Š**: 0ä¸ªè­¦å‘Š

### æµ‹è¯•ç­–ç•¥
- **å•å…ƒæµ‹è¯•**: æ¯ä¸ªæ¨¡å—ç‹¬ç«‹æµ‹è¯•
- **é›†æˆæµ‹è¯•**: æ¨¡å—é—´æ¥å£æµ‹è¯•
- **åŠŸèƒ½æµ‹è¯•**: ç«¯åˆ°ç«¯åŠŸèƒ½éªŒè¯
- **æ€§èƒ½æµ‹è¯•**: ä¸åŸç‰ˆæœ¬å¯¹æ¯”

### å…¼å®¹æ€§ä¿è¯
- **APIå…¼å®¹**: æ‰€æœ‰åŸæœ‰APIä¿æŒä¸å˜
- **é…ç½®å…¼å®¹**: é…ç½®æ–‡ä»¶æ ¼å¼ä¸å˜
- **éƒ¨ç½²å…¼å®¹**: éƒ¨ç½²æ–¹å¼ä¿æŒä¸€è‡´

## ğŸ”§ å¼€å‘æŒ‡å—

### ç¼–è¯‘å’Œè¿è¡Œ
```bash
# ç¼–è¯‘æ–°ç‰ˆæœ¬
./build_main_server.sh

# è¿è¡ŒæœåŠ¡å™¨
./main_server -p 8081

# æŸ¥çœ‹å¸®åŠ©
./main_server --help
```

### æ·»åŠ æ–°åŠŸèƒ½
1. åœ¨å¯¹åº”æ¨¡å—ä¸­æ·»åŠ åŠŸèƒ½
2. æ›´æ–°å¤´æ–‡ä»¶æ¥å£
3. åœ¨ VideoServer ä¸­æ³¨å†Œè·¯ç”±
4. æ›´æ–°ç¼–è¯‘è„šæœ¬
5. æ·»åŠ æµ‹è¯•ç”¨ä¾‹

### è°ƒè¯•å»ºè®®
- ä½¿ç”¨æ¨¡å—åŒ–æ—¥å¿—ç³»ç»Ÿ
- æ¯ä¸ªæ¨¡å—ç‹¬ç«‹è°ƒè¯•
- åˆ©ç”¨å•å…ƒæµ‹è¯•å¿«é€Ÿå®šä½é—®é¢˜

## ğŸ“ˆ é¢„æœŸæ”¶ç›Š

### å¼€å‘æ•ˆç‡æå‡
- **ç»´æŠ¤æˆæœ¬é™ä½**: 40%
- **æ–°åŠŸèƒ½å¼€å‘é€Ÿåº¦**: æå‡30%
- **Bugä¿®å¤æ—¶é—´**: å‡å°‘50%
- **ä»£ç å®¡æŸ¥æ•ˆç‡**: æå‡60%

### ä»£ç è´¨é‡æå‡
- **å¯è¯»æ€§**: æ˜¾è‘—æå‡
- **å¯æµ‹è¯•æ€§**: æ”¯æŒå•å…ƒæµ‹è¯•
- **å¯æ‰©å±•æ€§**: ä¾¿äºæ·»åŠ æ–°åŠŸèƒ½
- **å¯ç»´æŠ¤æ€§**: æ¨¡å—è¾¹ç•Œæ¸…æ™°

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**åˆ›å»ºæ—¥æœŸ**: 2024-05-24
**æœ€åæ›´æ–°**: 2024-05-24
**ç»´æŠ¤è€…**: å¼€å‘å›¢é˜Ÿ
