<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocketè§†é¢‘æµæµ‹è¯• (ä¿®å¤ç‰ˆ)</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .control-panel {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }
        .btn-primary { background-color: #007bff; color: white; }
        .btn-primary:hover { background-color: #0056b3; }
        .btn-success { background-color: #28a745; color: white; }
        .btn-success:hover { background-color: #1e7e34; }
        .btn-warning { background-color: #ffc107; color: black; }
        .btn-warning:hover { background-color: #e0a800; }
        .btn-danger { background-color: #dc3545; color: white; }
        .btn-danger:hover { background-color: #c82333; }
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .status-panel {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        .status-item {
            padding: 15px;
            border-radius: 4px;
            background-color: #f8f9fa;
            border-left: 4px solid #007bff;
        }
        .status-item h3 {
            margin: 0 0 10px 0;
            color: #333;
        }
        .status-value {
            font-size: 18px;
            font-weight: bold;
            color: #007bff;
        }
        .video-container {
            text-align: center;
            margin-bottom: 20px;
        }
        #videoCanvas {
            border: 2px solid #ddd;
            border-radius: 4px;
            max-width: 100%;
            background-color: #000;
        }
        .log-container {
            margin-top: 20px;
        }
        .log-content {
            font-family: 'Courier New', monospace;
            font-size: 12px;
            white-space: pre-wrap;
            background-color: #000;
            color: #00ff00;
            padding: 15px;
            border-radius: 4px;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
        }
        .connection-status {
            padding: 5px 10px;
            border-radius: 4px;
            font-weight: bold;
            display: inline-block;
            margin-bottom: 10px;
        }
        .status-connected { background-color: #d4edda; color: #155724; }
        .status-disconnected { background-color: #f8d7da; color: #721c24; }
        .status-connecting { background-color: #fff3cd; color: #856404; }
        .device-selector {
            margin-bottom: 15px;
        }
        select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¥ WebSocketè§†é¢‘æµæµ‹è¯• (ä¿®å¤ç‰ˆ)</h1>

        <!-- è¿æ¥çŠ¶æ€ -->
        <div class="connection-status status-disconnected" id="connectionStatus">
            æœªè¿æ¥
        </div>

        <!-- è®¾å¤‡é€‰æ‹© -->
        <div class="device-selector">
            <label for="deviceSelect">é€‰æ‹©æ‘„åƒå¤´è®¾å¤‡:</label>
            <select id="deviceSelect">
                <option value="/dev/video0">æ‘„åƒå¤´0 (/dev/video0)</option>
                <option value="/dev/video2">æ‘„åƒå¤´2 (/dev/video2)</option>
            </select>
        </div>

        <!-- æ§åˆ¶é¢æ¿ -->
        <div class="control-panel">
            <button id="connectBtn" class="btn-primary">è¿æ¥WebSocket</button>
            <button id="disconnectBtn" class="btn-danger" disabled>æ–­å¼€è¿æ¥</button>
            <button id="startCameraBtn" class="btn-success" disabled>å¯åŠ¨æ‘„åƒå¤´</button>
            <button id="stopCameraBtn" class="btn-warning" disabled>åœæ­¢æ‘„åƒå¤´</button>
            <button id="getStatusBtn" class="btn-primary" disabled>è·å–çŠ¶æ€</button>
            <button id="clearLogBtn" class="btn-warning">æ¸…ç©ºæ—¥å¿—</button>
        </div>

        <!-- çŠ¶æ€é¢æ¿ -->
        <div class="status-panel">
            <div class="status-item">
                <h3>ğŸ“· æ‘„åƒå¤´çŠ¶æ€</h3>
                <div class="status-value" id="cameraStatus">æœªçŸ¥</div>
            </div>
            <div class="status-item">
                <h3>ğŸ‘¥ è¿æ¥å®¢æˆ·ç«¯</h3>
                <div class="status-value" id="clientCount">0</div>
            </div>
            <div class="status-item">
                <h3>ğŸ“¦ æ¥æ”¶å¸§æ•°</h3>
                <div class="status-value" id="frameCount">0</div>
            </div>
            <div class="status-item">
                <h3>ğŸ”— å½“å‰è®¾å¤‡</h3>
                <div class="status-value" id="currentDevice">æ— </div>
            </div>
        </div>

        <!-- è§†é¢‘æ˜¾ç¤ºåŒºåŸŸ -->
        <div class="video-container">
            <canvas id="videoCanvas" width="640" height="480"></canvas>
        </div>

        <!-- æ—¥å¿—åŒºåŸŸ -->
        <div class="log-container">
            <h3>ğŸ“‹ æ—¥å¿—ä¿¡æ¯</h3>
            <div class="log-content" id="logContent"></div>
        </div>
    </div>

    <script>
        // DOMå…ƒç´ 
        const connectBtn = document.getElementById('connectBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');
        const startCameraBtn = document.getElementById('startCameraBtn');
        const stopCameraBtn = document.getElementById('stopCameraBtn');
        const getStatusBtn = document.getElementById('getStatusBtn');
        const clearLogBtn = document.getElementById('clearLogBtn');
        const deviceSelect = document.getElementById('deviceSelect');
        const connectionStatus = document.getElementById('connectionStatus');
        const cameraStatus = document.getElementById('cameraStatus');
        const clientCount = document.getElementById('clientCount');
        const frameCount = document.getElementById('frameCount');
        const currentDevice = document.getElementById('currentDevice');
        const logContent = document.getElementById('logContent');
        const videoCanvas = document.getElementById('videoCanvas');
        const ctx = videoCanvas.getContext('2d');

        // WebSocketè¿æ¥
        let ws = null;
        let receivedFrames = 0;

        // æ—¥å¿—å‡½æ•°
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logLine = `[${timestamp}] ${type.toUpperCase()}: ${message}\n`;
            logContent.textContent += logLine;
            logContent.scrollTop = logContent.scrollHeight;
            console.log(logLine);
        }

        // æ›´æ–°è¿æ¥çŠ¶æ€
        function updateConnectionStatus(status, className) {
            connectionStatus.textContent = status;
            connectionStatus.className = `connection-status ${className}`;
        }

        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        function updateButtons(connected) {
            connectBtn.disabled = connected;
            disconnectBtn.disabled = !connected;
            startCameraBtn.disabled = !connected;
            stopCameraBtn.disabled = !connected;
            getStatusBtn.disabled = !connected;
        }

        // è¿æ¥WebSocket
        function connectWebSocket() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                log('WebSocketå·²ç»è¿æ¥');
                return;
            }

            log('æ­£åœ¨è¿æ¥WebSocketè§†é¢‘æµæœåŠ¡å™¨...');
            updateConnectionStatus('è¿æ¥ä¸­...', 'status-connecting');

            // ä½¿ç”¨localhostè€Œä¸æ˜¯ç¡¬ç¼–ç IP
            ws = new WebSocket('ws://localhost:8081/ws/video');
            ws.binaryType = 'arraybuffer';

            ws.onopen = function() {
                log('âœ… WebSocketè¿æ¥æˆåŠŸ');
                updateConnectionStatus('å·²è¿æ¥', 'status-connected');
                updateButtons(true);
            };

            ws.onmessage = function(event) {
                // è¯¦ç»†è°ƒè¯•ä¿¡æ¯
                console.log('ğŸ“¨ æ”¶åˆ°WebSocketæ¶ˆæ¯:', {
                    type: typeof event.data,
                    constructor: event.data.constructor.name,
                    size: event.data.byteLength || event.data.length || 'unknown'
                });

                if (event.data instanceof ArrayBuffer) {
                    log('ğŸ“¦ æ”¶åˆ°ArrayBufferï¼Œå¤§å°: ' + event.data.byteLength + ' å­—èŠ‚');
                    handleVideoFrame(event.data);
                } else if (event.data instanceof Blob) {
                    log('ğŸ“¦ æ”¶åˆ°Blobï¼Œå¤§å°: ' + event.data.size + ' å­—èŠ‚');
                    // å°†Blobè½¬æ¢ä¸ºArrayBuffer
                    event.data.arrayBuffer().then(function(arrayBuffer) {
                        handleVideoFrame(arrayBuffer);
                    });
                } else if (typeof event.data === 'string') {
                    // å¤„ç†æ–‡æœ¬æ¶ˆæ¯
                    handleTextMessage(event.data);
                } else {
                    log('â“ æœªçŸ¥æ¶ˆæ¯ç±»å‹: ' + typeof event.data + ', constructor: ' + event.data.constructor.name);
                }
            };

            ws.onerror = function(error) {
                log('âŒ WebSocketè¿æ¥é”™è¯¯: ' + error, 'error');
                updateConnectionStatus('è¿æ¥é”™è¯¯', 'status-disconnected');
                updateButtons(false);
            };

            ws.onclose = function() {
                log('ğŸ”Œ WebSocketè¿æ¥å·²å…³é—­');
                updateConnectionStatus('æœªè¿æ¥', 'status-disconnected');
                updateButtons(false);
                ws = null;
            };
        }

        // æ–­å¼€WebSocket
        function disconnectWebSocket() {
            if (ws) {
                ws.close();
                ws = null;
            }
        }

        // å¤„ç†æ–‡æœ¬æ¶ˆæ¯
        function handleTextMessage(data) {
            try {
                const message = JSON.parse(data);
                log('ğŸ“¨ æ”¶åˆ°æ¶ˆæ¯: ' + data);

                switch (message.type) {
                    case 'welcome':
                        log('ğŸ‰ ' + message.message);
                        break;
                    case 'success':
                        log('âœ… ' + message.message);
                        break;
                    case 'error':
                        log('âŒ ' + message.message, 'error');
                        break;
                    case 'status':
                        updateStatus(message);
                        break;
                    default:
                        log('ğŸ“‹ æœªçŸ¥æ¶ˆæ¯ç±»å‹: ' + message.type);
                }
            } catch (e) {
                log('ğŸ“‹ æ”¶åˆ°éJSONæ¶ˆæ¯: ' + data);
            }
        }

        // å¤„ç†è§†é¢‘å¸§
        function handleVideoFrame(arrayBuffer) {
            receivedFrames++;
            frameCount.textContent = receivedFrames;

            try {
                // å°†ArrayBufferè½¬æ¢ä¸ºBlob
                const blob = new Blob([arrayBuffer], { type: 'image/jpeg' });
                const url = URL.createObjectURL(blob);

                // åˆ›å»ºå›¾åƒå¯¹è±¡
                const img = new Image();
                img.onload = function() {
                    try {
                        // åœ¨canvasä¸Šç»˜åˆ¶å›¾åƒ
                        ctx.clearRect(0, 0, videoCanvas.width, videoCanvas.height);
                        ctx.drawImage(img, 0, 0, videoCanvas.width, videoCanvas.height);
                        URL.revokeObjectURL(url);

                        // è°ƒè¯•ä¿¡æ¯ï¼šå›¾åƒç»˜åˆ¶æˆåŠŸ
                        if (receivedFrames <= 3) {
                            log('âœ… å›¾åƒç»˜åˆ¶æˆåŠŸï¼Œå°ºå¯¸: ' + img.width + 'x' + img.height);
                        }
                    } catch (drawError) {
                        log('âŒ Canvasç»˜åˆ¶å¤±è´¥: ' + drawError.message, 'error');
                        URL.revokeObjectURL(url);
                    }
                };

                img.onerror = function() {
                    log('âŒ å›¾åƒåŠ è½½å¤±è´¥', 'error');
                    URL.revokeObjectURL(url);
                };

                img.src = url;

                // åªåœ¨å‰å‡ å¸§æˆ–æ¯100å¸§è®°å½•ä¸€æ¬¡æ—¥å¿—ï¼Œé¿å…æ—¥å¿—è¿‡å¤š
                if (receivedFrames <= 5 || receivedFrames % 100 === 0) {
                    log('ğŸ“· æ”¶åˆ°è§†é¢‘å¸§ï¼Œå¤§å°: ' + arrayBuffer.byteLength + ' å­—èŠ‚');
                }

                // å¼ºåˆ¶æ˜¾ç¤ºå‰å‡ å¸§çš„è¯¦ç»†è°ƒè¯•ä¿¡æ¯
                if (receivedFrames <= 3) {
                    log('ğŸ” Canvaså°ºå¯¸: ' + videoCanvas.width + 'x' + videoCanvas.height);
                    log('ğŸ” Contextç±»å‹: ' + (ctx ? 'OK' : 'NULL'));
                    log('ğŸ” ArrayBufferå¤§å°: ' + arrayBuffer.byteLength);
                    log('ğŸ” Blobåˆ›å»ºä¸­...');
                }

            } catch (e) {
                log('âŒ å¤„ç†è§†é¢‘å¸§å¤±è´¥: ' + e.message, 'error');
            }
        }

        // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
        function updateStatus(status) {
            cameraStatus.textContent = status.camera_capturing ? 'è¿è¡Œä¸­' :
                                     (status.camera_open ? 'å·²æ‰“å¼€' : 'å·²å…³é—­');
            clientCount.textContent = status.client_count || 0;
            currentDevice.textContent = status.device_path || 'æ— ';
        }

        // å‘é€å‘½ä»¤ - ä¿®å¤åçš„ç‰ˆæœ¬ï¼ŒåŒ¹é…åç«¯æœŸæœ›çš„æ ¼å¼
        function sendCommand(action) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                const device = deviceSelect.value;
                let command;

                // æ ¹æ®åç«¯ä»£ç çš„è§£ææ–¹å¼æ„é€ å‘½ä»¤
                if (action === 'start_camera') {
                    command = JSON.stringify({
                        action: "start_camera",
                        device: device
                    });
                } else {
                    command = JSON.stringify({ action: action });
                }

                ws.send(command);
                log('ğŸ“¤ å‘é€å‘½ä»¤: ' + command);
            } else {
                log('âŒ WebSocketæœªè¿æ¥', 'error');
            }
        }

        // å¯åŠ¨æ‘„åƒå¤´
        function startCamera() {
            sendCommand('start_camera');
        }

        // åœæ­¢æ‘„åƒå¤´
        function stopCamera() {
            sendCommand('stop_camera');
        }

        // è·å–çŠ¶æ€
        function getStatus() {
            sendCommand('get_status');
        }

        // æ¸…ç©ºæ—¥å¿—
        function clearLog() {
            logContent.textContent = '';
            receivedFrames = 0;
            frameCount.textContent = '0';
            log('æ—¥å¿—å·²æ¸…ç©º');
        }

        // äº‹ä»¶ç›‘å¬å™¨
        connectBtn.addEventListener('click', connectWebSocket);
        disconnectBtn.addEventListener('click', disconnectWebSocket);
        startCameraBtn.addEventListener('click', startCamera);
        stopCameraBtn.addEventListener('click', stopCamera);
        getStatusBtn.addEventListener('click', getStatus);
        clearLogBtn.addEventListener('click', clearLog);

        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            log('WebSocketè§†é¢‘æµæµ‹è¯•é¡µé¢å·²åŠ è½½ (ä¿®å¤ç‰ˆ)');
            log('ç‚¹å‡»"è¿æ¥WebSocket"å¼€å§‹æµ‹è¯•');
            log('ç¡®ä¿æœåŠ¡å™¨è¿è¡Œåœ¨ localhost:8081');
        });

        // é¡µé¢å¸è½½æ—¶æ¸…ç†
        window.addEventListener('beforeunload', function() {
            if (ws) {
                ws.close();
            }
        });
    </script>
</body>
</html>
